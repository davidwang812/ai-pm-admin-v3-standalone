<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>配置持久化诊断工具</title>
    <style>
        body { font-family: -apple-system, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #e8e8e8; border-radius: 6px; }
        .section h3 { margin-top: 0; color: #1890ff; }
        .success { background: #f6ffed; border-color: #b7eb8f; }
        .warning { background: #fffbe6; border-color: #ffe58f; }
        .error { background: #fff2f0; border-color: #ffccc7; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; max-height: 300px; font-size: 12px; }
        .button { background: #1890ff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin: 5px; }
        .button:hover { background: #40a9ff; }
        .button.danger { background: #ff4d4f; }
        .button.danger:hover { background: #ff7875; }
        .status { padding: 8px 12px; border-radius: 4px; margin: 5px 0; }
        .config-item { margin: 10px 0; padding: 10px; background: #fafafa; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 配置持久化诊断工具</h1>
        <p><strong>问题：</strong>保存设置刷新之后设置就不见了</p>
        
        <div class="section">
            <h3>📊 当前存储状态</h3>
            <div id="storage-status">正在检查...</div>
            <button class="button" onclick="checkStorage()">🔄 检查存储</button>
            <button class="button" onclick="clearStorage()">🗑️ 清空存储</button>
            <button class="button" onclick="exportConfig()">📤 导出配置</button>
        </div>

        <div class="section">
            <h3>🔧 LocalStorage 内容</h3>
            <div id="localStorage-content">
                <pre id="localStorage-data">加载中...</pre>
            </div>
        </div>

        <div class="section">
            <h3>🧪 配置测试</h3>
            <div class="config-item">
                <label>测试温度设置: </label>
                <input type="range" id="test-temperature" min="0" max="2" step="0.1" value="0.7">
                <span id="test-temperature-value">0.7</span>
            </div>
            <div class="config-item">
                <label>测试服务启用: </label>
                <input type="checkbox" id="test-service-enabled" checked>
                <span>提问AI服务</span>
            </div>
            <button class="button" onclick="saveTestConfig()">💾 保存测试配置</button>
            <button class="button" onclick="loadTestConfig()">📥 加载测试配置</button>
            <div id="test-result"></div>
        </div>

        <div class="section">
            <h3>🚨 问题诊断</h3>
            <div id="diagnosis-result">
                <p>点击下方按钮开始诊断...</p>
            </div>
            <button class="button" onclick="runDiagnosis()">🔍 运行完整诊断</button>
        </div>

        <div class="section">
            <h3>🔧 修复工具</h3>
            <button class="button" onclick="fixConfigStructure()">🛠️ 修复配置结构</button>
            <button class="button" onclick="resetToDefaults()">⚡ 重置为默认值</button>
            <button class="button danger" onclick="clearAllConfigs()">🗑️ 清空所有配置</button>
            <div id="fix-result"></div>
        </div>
    </div>

    <script>
        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            checkStorage();
            
            // 绑定滑块事件
            const tempSlider = document.getElementById('test-temperature');
            const tempValue = document.getElementById('test-temperature-value');
            tempSlider.addEventListener('input', function() {
                tempValue.textContent = this.value;
            });
        });

        function checkStorage() {
            const keys = [
                'unified_config',
                'admin_providers', 
                'ai_service_config',
                'global_config',
                'provider_config'
            ];
            
            let html = '<h4>📋 LocalStorage 键值对：</h4>';
            let totalItems = 0;
            
            keys.forEach(key => {
                const value = localStorage.getItem(key);
                if (value) {
                    totalItems++;
                    const size = new Blob([value]).size;
                    html += `
                        <div class="status success">
                            <strong>${key}:</strong> ${size} bytes
                            <button class="button" onclick="showConfig('${key}')">查看</button>
                            <button class="button danger" onclick="deleteKey('${key}')">删除</button>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="status warning">
                            <strong>${key}:</strong> 不存在
                        </div>
                    `;
                }
            });
            
            html += `<p><strong>总计：</strong>${totalItems} 个配置项</p>`;
            document.getElementById('storage-status').innerHTML = html;
            
            updateLocalStorageDisplay();
        }

        function updateLocalStorageDisplay() {
            const config = localStorage.getItem('unified_config');
            if (config) {
                try {
                    const parsed = JSON.parse(config);
                    document.getElementById('localStorage-data').textContent = JSON.stringify(parsed, null, 2);
                } catch (e) {
                    document.getElementById('localStorage-data').textContent = '配置解析失败: ' + e.message + '\\n\\n原始数据:\\n' + config;
                }
            } else {
                document.getElementById('localStorage-data').textContent = '没有找到 unified_config';
            }
        }

        function showConfig(key) {
            const value = localStorage.getItem(key);
            if (value) {
                try {
                    const parsed = JSON.parse(value);
                    alert(JSON.stringify(parsed, null, 2));
                } catch (e) {
                    alert('原始值:\\n' + value);
                }
            }
        }

        function deleteKey(key) {
            if (confirm(`确定要删除 ${key} 吗？`)) {
                localStorage.removeItem(key);
                checkStorage();
            }
        }

        function clearStorage() {
            if (confirm('确定要清空所有相关存储吗？')) {
                const keys = ['unified_config', 'admin_providers', 'ai_service_config', 'global_config', 'provider_config'];
                keys.forEach(key => localStorage.removeItem(key));
                checkStorage();
            }
        }

        function exportConfig() {
            const config = localStorage.getItem('unified_config');
            if (config) {
                const blob = new Blob([config], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'unified_config_' + new Date().getTime() + '.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } else {
                alert('没有配置可导出');
            }
        }

        function saveTestConfig() {
            const testConfig = {
                globalParams: {
                    temperature: parseFloat(document.getElementById('test-temperature').value),
                    topP: 0.9,
                    maxTokens: 2000
                },
                aiServices: {
                    questionAI: {
                        enabled: document.getElementById('test-service-enabled').checked,
                        provider: 'openai',
                        temperature: parseFloat(document.getElementById('test-temperature').value),
                        topP: 0.9,
                        maxTokens: 2000,
                        prompt: '这是一个测试提示词'
                    }
                },
                lastUpdated: new Date().toISOString(),
                testMode: true
            };
            
            localStorage.setItem('unified_config', JSON.stringify(testConfig));
            document.getElementById('test-result').innerHTML = '<div class="status success">✅ 测试配置已保存</div>';
            updateLocalStorageDisplay();
        }

        function loadTestConfig() {
            const config = localStorage.getItem('unified_config');
            if (config) {
                try {
                    const parsed = JSON.parse(config);
                    if (parsed.globalParams) {
                        document.getElementById('test-temperature').value = parsed.globalParams.temperature || 0.7;
                        document.getElementById('test-temperature-value').textContent = parsed.globalParams.temperature || 0.7;
                    }
                    if (parsed.aiServices && parsed.aiServices.questionAI) {
                        document.getElementById('test-service-enabled').checked = parsed.aiServices.questionAI.enabled || false;
                    }
                    document.getElementById('test-result').innerHTML = '<div class="status success">✅ 测试配置已加载</div>';
                } catch (e) {
                    document.getElementById('test-result').innerHTML = '<div class="status error">❌ 配置解析失败: ' + e.message + '</div>';
                }
            } else {
                document.getElementById('test-result').innerHTML = '<div class="status warning">⚠️ 没有找到配置</div>';
            }
        }

        function runDiagnosis() {
            let diagnosis = '';
            const config = localStorage.getItem('unified_config');
            
            if (!config) {
                diagnosis += '<div class="status error">❌ 关键问题：unified_config 不存在于 localStorage</div>';
                diagnosis += '<p><strong>可能原因：</strong></p><ul><li>配置从未被保存</li><li>localStorage 被清空</li><li>保存时使用了错误的键名</li></ul>';
            } else {
                try {
                    const parsed = JSON.parse(config);
                    diagnosis += '<div class="status success">✅ unified_config 存在且可解析</div>';
                    
                    // 检查必要的字段
                    if (!parsed.globalParams) {
                        diagnosis += '<div class="status warning">⚠️ 缺少 globalParams 字段</div>';
                    }
                    if (!parsed.aiServices) {
                        diagnosis += '<div class="status warning">⚠️ 缺少 aiServices 字段</div>';
                    }
                    
                    // 检查数据完整性
                    if (parsed.lastUpdated) {
                        const lastUpdate = new Date(parsed.lastUpdated);
                        const now = new Date();
                        const timeDiff = now - lastUpdate;
                        diagnosis += `<div class="status success">✅ 配置更新时间：${lastUpdate.toLocaleString()} (${Math.round(timeDiff / 1000 / 60)} 分钟前)</div>`;
                    }
                    
                } catch (e) {
                    diagnosis += '<div class="status error">❌ 关键问题：unified_config 存储但无法解析</div>';
                    diagnosis += '<p><strong>错误：</strong>' + e.message + '</p>';
                }
            }
            
            // 检查页面加载逻辑
            diagnosis += '<h4>🔧 建议修复步骤：</h4>';
            diagnosis += '<ol>';
            diagnosis += '<li>清空现有配置并重新保存</li>';
            diagnosis += '<li>检查页面刷新时配置加载逻辑</li>';
            diagnosis += '<li>验证API保存和加载功能</li>';
            diagnosis += '<li>确保配置结构正确</li>';
            diagnosis += '</ol>';
            
            document.getElementById('diagnosis-result').innerHTML = diagnosis;
        }

        function fixConfigStructure() {
            const defaultConfig = {
                globalParams: {
                    temperature: 0.7,
                    topP: 0.9,
                    maxTokens: 2000
                },
                aiServices: {
                    questionAI: {
                        enabled: true,
                        provider: 'openai',
                        providerId: '3',
                        prompt: '你是一个专业的问答助手',
                        temperature: 0.7,
                        topP: 0.9,
                        maxTokens: 2000
                    },
                    drawingAI: {
                        enabled: true,
                        provider: 'google',
                        providerId: '2',
                        prompt: '你是一个图像生成助手',
                        temperature: 0.8,
                        topP: 0.95,
                        maxTokens: 1000
                    },
                    assistantAI: {
                        enabled: true,
                        provider: 'moonshot',
                        providerId: '1',
                        prompt: '你是一个全能助手',
                        temperature: 0.7,
                        topP: 0.9,
                        maxTokens: 2000
                    },
                    translationAI: {
                        enabled: true,
                        provider: 'google',
                        providerId: '6',
                        prompt: '你是一个专业的翻译助手',
                        temperature: 0.3,
                        topP: 0.8,
                        maxTokens: 1500
                    },
                    ratingAI: {
                        enabled: false,
                        provider: 'openai',
                        prompt: '你是一个专业的评分助手',
                        temperature: 0.5,
                        topP: 0.8,
                        maxTokens: 1000
                    }
                },
                lastUpdated: new Date().toISOString()
            };
            
            localStorage.setItem('unified_config', JSON.stringify(defaultConfig));
            document.getElementById('fix-result').innerHTML = '<div class="status success">✅ 配置结构已修复为标准格式</div>';
            checkStorage();
        }

        function resetToDefaults() {
            if (confirm('确定要重置为默认配置吗？这将清除所有自定义设置。')) {
                fixConfigStructure();
                document.getElementById('fix-result').innerHTML = '<div class="status success">✅ 已重置为默认配置</div>';
            }
        }

        function clearAllConfigs() {
            if (confirm('确定要清空所有配置吗？这个操作不可恢复！')) {
                localStorage.clear();
                document.getElementById('fix-result').innerHTML = '<div class="status warning">⚠️ 所有配置已清空</div>';
                checkStorage();
            }
        }
    </script>
</body>
</html>