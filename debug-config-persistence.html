<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é…ç½®æŒä¹…åŒ–è¯Šæ–­å·¥å…·</title>
    <style>
        body { font-family: -apple-system, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #e8e8e8; border-radius: 6px; }
        .section h3 { margin-top: 0; color: #1890ff; }
        .success { background: #f6ffed; border-color: #b7eb8f; }
        .warning { background: #fffbe6; border-color: #ffe58f; }
        .error { background: #fff2f0; border-color: #ffccc7; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; max-height: 300px; font-size: 12px; }
        .button { background: #1890ff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin: 5px; }
        .button:hover { background: #40a9ff; }
        .button.danger { background: #ff4d4f; }
        .button.danger:hover { background: #ff7875; }
        .status { padding: 8px 12px; border-radius: 4px; margin: 5px 0; }
        .config-item { margin: 10px 0; padding: 10px; background: #fafafa; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” é…ç½®æŒä¹…åŒ–è¯Šæ–­å·¥å…·</h1>
        <p><strong>é—®é¢˜ï¼š</strong>ä¿å­˜è®¾ç½®åˆ·æ–°ä¹‹åè®¾ç½®å°±ä¸è§äº†</p>
        
        <div class="section">
            <h3>ğŸ“Š å½“å‰å­˜å‚¨çŠ¶æ€</h3>
            <div id="storage-status">æ­£åœ¨æ£€æŸ¥...</div>
            <button class="button" onclick="checkStorage()">ğŸ”„ æ£€æŸ¥å­˜å‚¨</button>
            <button class="button" onclick="clearStorage()">ğŸ—‘ï¸ æ¸…ç©ºå­˜å‚¨</button>
            <button class="button" onclick="exportConfig()">ğŸ“¤ å¯¼å‡ºé…ç½®</button>
        </div>

        <div class="section">
            <h3>ğŸ”§ LocalStorage å†…å®¹</h3>
            <div id="localStorage-content">
                <pre id="localStorage-data">åŠ è½½ä¸­...</pre>
            </div>
        </div>

        <div class="section">
            <h3>ğŸ§ª é…ç½®æµ‹è¯•</h3>
            <div class="config-item">
                <label>æµ‹è¯•æ¸©åº¦è®¾ç½®: </label>
                <input type="range" id="test-temperature" min="0" max="2" step="0.1" value="0.7">
                <span id="test-temperature-value">0.7</span>
            </div>
            <div class="config-item">
                <label>æµ‹è¯•æœåŠ¡å¯ç”¨: </label>
                <input type="checkbox" id="test-service-enabled" checked>
                <span>æé—®AIæœåŠ¡</span>
            </div>
            <button class="button" onclick="saveTestConfig()">ğŸ’¾ ä¿å­˜æµ‹è¯•é…ç½®</button>
            <button class="button" onclick="loadTestConfig()">ğŸ“¥ åŠ è½½æµ‹è¯•é…ç½®</button>
            <div id="test-result"></div>
        </div>

        <div class="section">
            <h3>ğŸš¨ é—®é¢˜è¯Šæ–­</h3>
            <div id="diagnosis-result">
                <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹è¯Šæ–­...</p>
            </div>
            <button class="button" onclick="runDiagnosis()">ğŸ” è¿è¡Œå®Œæ•´è¯Šæ–­</button>
        </div>

        <div class="section">
            <h3>ğŸ”§ ä¿®å¤å·¥å…·</h3>
            <button class="button" onclick="fixConfigStructure()">ğŸ› ï¸ ä¿®å¤é…ç½®ç»“æ„</button>
            <button class="button" onclick="resetToDefaults()">âš¡ é‡ç½®ä¸ºé»˜è®¤å€¼</button>
            <button class="button danger" onclick="clearAllConfigs()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰é…ç½®</button>
            <div id="fix-result"></div>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            checkStorage();
            
            // ç»‘å®šæ»‘å—äº‹ä»¶
            const tempSlider = document.getElementById('test-temperature');
            const tempValue = document.getElementById('test-temperature-value');
            tempSlider.addEventListener('input', function() {
                tempValue.textContent = this.value;
            });
        });

        function checkStorage() {
            const keys = [
                'unified_config',
                'admin_providers', 
                'ai_service_config',
                'global_config',
                'provider_config'
            ];
            
            let html = '<h4>ğŸ“‹ LocalStorage é”®å€¼å¯¹ï¼š</h4>';
            let totalItems = 0;
            
            keys.forEach(key => {
                const value = localStorage.getItem(key);
                if (value) {
                    totalItems++;
                    const size = new Blob([value]).size;
                    html += `
                        <div class="status success">
                            <strong>${key}:</strong> ${size} bytes
                            <button class="button" onclick="showConfig('${key}')">æŸ¥çœ‹</button>
                            <button class="button danger" onclick="deleteKey('${key}')">åˆ é™¤</button>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="status warning">
                            <strong>${key}:</strong> ä¸å­˜åœ¨
                        </div>
                    `;
                }
            });
            
            html += `<p><strong>æ€»è®¡ï¼š</strong>${totalItems} ä¸ªé…ç½®é¡¹</p>`;
            document.getElementById('storage-status').innerHTML = html;
            
            updateLocalStorageDisplay();
        }

        function updateLocalStorageDisplay() {
            const config = localStorage.getItem('unified_config');
            if (config) {
                try {
                    const parsed = JSON.parse(config);
                    document.getElementById('localStorage-data').textContent = JSON.stringify(parsed, null, 2);
                } catch (e) {
                    document.getElementById('localStorage-data').textContent = 'é…ç½®è§£æå¤±è´¥: ' + e.message + '\\n\\nåŸå§‹æ•°æ®:\\n' + config;
                }
            } else {
                document.getElementById('localStorage-data').textContent = 'æ²¡æœ‰æ‰¾åˆ° unified_config';
            }
        }

        function showConfig(key) {
            const value = localStorage.getItem(key);
            if (value) {
                try {
                    const parsed = JSON.parse(value);
                    alert(JSON.stringify(parsed, null, 2));
                } catch (e) {
                    alert('åŸå§‹å€¼:\\n' + value);
                }
            }
        }

        function deleteKey(key) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤ ${key} å—ï¼Ÿ`)) {
                localStorage.removeItem(key);
                checkStorage();
            }
        }

        function clearStorage() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç›¸å…³å­˜å‚¨å—ï¼Ÿ')) {
                const keys = ['unified_config', 'admin_providers', 'ai_service_config', 'global_config', 'provider_config'];
                keys.forEach(key => localStorage.removeItem(key));
                checkStorage();
            }
        }

        function exportConfig() {
            const config = localStorage.getItem('unified_config');
            if (config) {
                const blob = new Blob([config], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'unified_config_' + new Date().getTime() + '.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } else {
                alert('æ²¡æœ‰é…ç½®å¯å¯¼å‡º');
            }
        }

        function saveTestConfig() {
            const testConfig = {
                globalParams: {
                    temperature: parseFloat(document.getElementById('test-temperature').value),
                    topP: 0.9,
                    maxTokens: 2000
                },
                aiServices: {
                    questionAI: {
                        enabled: document.getElementById('test-service-enabled').checked,
                        provider: 'openai',
                        temperature: parseFloat(document.getElementById('test-temperature').value),
                        topP: 0.9,
                        maxTokens: 2000,
                        prompt: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æç¤ºè¯'
                    }
                },
                lastUpdated: new Date().toISOString(),
                testMode: true
            };
            
            localStorage.setItem('unified_config', JSON.stringify(testConfig));
            document.getElementById('test-result').innerHTML = '<div class="status success">âœ… æµ‹è¯•é…ç½®å·²ä¿å­˜</div>';
            updateLocalStorageDisplay();
        }

        function loadTestConfig() {
            const config = localStorage.getItem('unified_config');
            if (config) {
                try {
                    const parsed = JSON.parse(config);
                    if (parsed.globalParams) {
                        document.getElementById('test-temperature').value = parsed.globalParams.temperature || 0.7;
                        document.getElementById('test-temperature-value').textContent = parsed.globalParams.temperature || 0.7;
                    }
                    if (parsed.aiServices && parsed.aiServices.questionAI) {
                        document.getElementById('test-service-enabled').checked = parsed.aiServices.questionAI.enabled || false;
                    }
                    document.getElementById('test-result').innerHTML = '<div class="status success">âœ… æµ‹è¯•é…ç½®å·²åŠ è½½</div>';
                } catch (e) {
                    document.getElementById('test-result').innerHTML = '<div class="status error">âŒ é…ç½®è§£æå¤±è´¥: ' + e.message + '</div>';
                }
            } else {
                document.getElementById('test-result').innerHTML = '<div class="status warning">âš ï¸ æ²¡æœ‰æ‰¾åˆ°é…ç½®</div>';
            }
        }

        function runDiagnosis() {
            let diagnosis = '';
            const config = localStorage.getItem('unified_config');
            
            if (!config) {
                diagnosis += '<div class="status error">âŒ å…³é”®é—®é¢˜ï¼šunified_config ä¸å­˜åœ¨äº localStorage</div>';
                diagnosis += '<p><strong>å¯èƒ½åŸå› ï¼š</strong></p><ul><li>é…ç½®ä»æœªè¢«ä¿å­˜</li><li>localStorage è¢«æ¸…ç©º</li><li>ä¿å­˜æ—¶ä½¿ç”¨äº†é”™è¯¯çš„é”®å</li></ul>';
            } else {
                try {
                    const parsed = JSON.parse(config);
                    diagnosis += '<div class="status success">âœ… unified_config å­˜åœ¨ä¸”å¯è§£æ</div>';
                    
                    // æ£€æŸ¥å¿…è¦çš„å­—æ®µ
                    if (!parsed.globalParams) {
                        diagnosis += '<div class="status warning">âš ï¸ ç¼ºå°‘ globalParams å­—æ®µ</div>';
                    }
                    if (!parsed.aiServices) {
                        diagnosis += '<div class="status warning">âš ï¸ ç¼ºå°‘ aiServices å­—æ®µ</div>';
                    }
                    
                    // æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
                    if (parsed.lastUpdated) {
                        const lastUpdate = new Date(parsed.lastUpdated);
                        const now = new Date();
                        const timeDiff = now - lastUpdate;
                        diagnosis += `<div class="status success">âœ… é…ç½®æ›´æ–°æ—¶é—´ï¼š${lastUpdate.toLocaleString()} (${Math.round(timeDiff / 1000 / 60)} åˆ†é’Ÿå‰)</div>`;
                    }
                    
                } catch (e) {
                    diagnosis += '<div class="status error">âŒ å…³é”®é—®é¢˜ï¼šunified_config å­˜å‚¨ä½†æ— æ³•è§£æ</div>';
                    diagnosis += '<p><strong>é”™è¯¯ï¼š</strong>' + e.message + '</p>';
                }
            }
            
            // æ£€æŸ¥é¡µé¢åŠ è½½é€»è¾‘
            diagnosis += '<h4>ğŸ”§ å»ºè®®ä¿®å¤æ­¥éª¤ï¼š</h4>';
            diagnosis += '<ol>';
            diagnosis += '<li>æ¸…ç©ºç°æœ‰é…ç½®å¹¶é‡æ–°ä¿å­˜</li>';
            diagnosis += '<li>æ£€æŸ¥é¡µé¢åˆ·æ–°æ—¶é…ç½®åŠ è½½é€»è¾‘</li>';
            diagnosis += '<li>éªŒè¯APIä¿å­˜å’ŒåŠ è½½åŠŸèƒ½</li>';
            diagnosis += '<li>ç¡®ä¿é…ç½®ç»“æ„æ­£ç¡®</li>';
            diagnosis += '</ol>';
            
            document.getElementById('diagnosis-result').innerHTML = diagnosis;
        }

        function fixConfigStructure() {
            const defaultConfig = {
                globalParams: {
                    temperature: 0.7,
                    topP: 0.9,
                    maxTokens: 2000
                },
                aiServices: {
                    questionAI: {
                        enabled: true,
                        provider: 'openai',
                        providerId: '3',
                        prompt: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„é—®ç­”åŠ©æ‰‹',
                        temperature: 0.7,
                        topP: 0.9,
                        maxTokens: 2000
                    },
                    drawingAI: {
                        enabled: true,
                        provider: 'google',
                        providerId: '2',
                        prompt: 'ä½ æ˜¯ä¸€ä¸ªå›¾åƒç”ŸæˆåŠ©æ‰‹',
                        temperature: 0.8,
                        topP: 0.95,
                        maxTokens: 1000
                    },
                    assistantAI: {
                        enabled: true,
                        provider: 'moonshot',
                        providerId: '1',
                        prompt: 'ä½ æ˜¯ä¸€ä¸ªå…¨èƒ½åŠ©æ‰‹',
                        temperature: 0.7,
                        topP: 0.9,
                        maxTokens: 2000
                    },
                    translationAI: {
                        enabled: true,
                        provider: 'google',
                        providerId: '6',
                        prompt: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç¿»è¯‘åŠ©æ‰‹',
                        temperature: 0.3,
                        topP: 0.8,
                        maxTokens: 1500
                    },
                    ratingAI: {
                        enabled: false,
                        provider: 'openai',
                        prompt: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è¯„åˆ†åŠ©æ‰‹',
                        temperature: 0.5,
                        topP: 0.8,
                        maxTokens: 1000
                    }
                },
                lastUpdated: new Date().toISOString()
            };
            
            localStorage.setItem('unified_config', JSON.stringify(defaultConfig));
            document.getElementById('fix-result').innerHTML = '<div class="status success">âœ… é…ç½®ç»“æ„å·²ä¿®å¤ä¸ºæ ‡å‡†æ ¼å¼</div>';
            checkStorage();
        }

        function resetToDefaults() {
            if (confirm('ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤é…ç½®å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰è‡ªå®šä¹‰è®¾ç½®ã€‚')) {
                fixConfigStructure();
                document.getElementById('fix-result').innerHTML = '<div class="status success">âœ… å·²é‡ç½®ä¸ºé»˜è®¤é…ç½®</div>';
            }
        }

        function clearAllConfigs() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰é…ç½®å—ï¼Ÿè¿™ä¸ªæ“ä½œä¸å¯æ¢å¤ï¼')) {
                localStorage.clear();
                document.getElementById('fix-result').innerHTML = '<div class="status warning">âš ï¸ æ‰€æœ‰é…ç½®å·²æ¸…ç©º</div>';
                checkStorage();
            }
        }
    </script>
</body>
</html>