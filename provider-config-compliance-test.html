<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🧪 服务商配置功能与数据库契约测试</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .test-result {
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .json-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            overflow-x: auto;
            max-height: 300px;
            overflow-y: auto;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin: 2px;
        }
        .compliant {
            background: #28a745;
            color: white;
        }
        .non-compliant {
            background: #dc3545;
            color: white;
        }
        .partial {
            background: #ffc107;
            color: #212529;
        }
        .contract-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .contract-table th,
        .contract-table td {
            border: 1px solid #dee2e6;
            padding: 8px 12px;
            text-align: left;
        }
        .contract-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        .flex-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .flex-item {
            flex: 1;
            min-width: 300px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🧪 服务商配置功能与数据库契约测试</h1>
            <p>全面测试AI服务商配置的所有按钮功能和数据库契约合规性</p>
        </div>

        <div class="test-section">
            <h3>📋 Test 1: 服务商配置模块加载测试</h3>
            <button onclick="testModuleLoading()">测试模块加载</button>
            <div id="module-loading-result"></div>
        </div>

        <div class="test-section">
            <h3>🔗 Test 2: API连接和数据加载测试</h3>
            <button onclick="testAPIConnection()">测试API连接</button>
            <div id="api-connection-result"></div>
        </div>

        <div class="test-section">
            <h3>📊 Test 3: 数据库契约合规性验证</h3>
            <button onclick="testDatabaseContract()">验证数据库契约</button>
            <div id="database-contract-result"></div>
        </div>

        <div class="test-section">
            <h3>🎯 Test 4: CRUD操作按钮功能测试</h3>
            <div class="flex-container">
                <div class="flex-item">
                    <h4>创建操作</h4>
                    <button onclick="testAddProviderButton()">测试添加服务商</button>
                    <div id="add-provider-result"></div>
                </div>
                <div class="flex-item">
                    <h4>读取操作</h4>
                    <button onclick="testLoadProviders()">测试加载服务商</button>
                    <div id="load-providers-result"></div>
                </div>
            </div>
            <div class="flex-container">
                <div class="flex-item">
                    <h4>更新操作</h4>
                    <button onclick="testEditProviderButton()">测试编辑服务商</button>
                    <div id="edit-provider-result"></div>
                </div>
                <div class="flex-item">
                    <h4>删除操作</h4>
                    <button onclick="testDeleteProviderButton()">测试删除服务商</button>
                    <div id="delete-provider-result"></div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>⚙️ Test 5: 服务商操作按钮功能测试</h3>
            <div class="flex-container">
                <div class="flex-item">
                    <button onclick="testToggleProviderButton()">测试启用/禁用按钮</button>
                    <div id="toggle-provider-result"></div>
                </div>
                <div class="flex-item">
                    <button onclick="testConnectionButton()">测试连接测试按钮</button>
                    <div id="test-connection-result"></div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>🔒 Test 6: 数据验证和安全测试</h3>
            <button onclick="testDataValidation()">测试数据验证</button>
            <div id="data-validation-result"></div>
        </div>

        <div class="test-section">
            <h3>📈 Test 7: 用户体验和错误处理测试</h3>
            <button onclick="testErrorHandling()">测试错误处理</button>
            <div id="error-handling-result"></div>
        </div>

        <div class="test-section">
            <h3>🎯 最终测试结果</h3>
            <button onclick="runAllTests()">运行所有测试</button>
            <div id="final-result"></div>
        </div>
    </div>

    <script type="module">
        // 数据库契约定义
        const DATABASE_CONTRACT = {
            AI_SERVICES: {
                service_id: { type: 'bigint', constraint: 'PK', description: '服务ID' },
                service_name: { type: 'varchar', constraint: 'UK', description: '服务名称' },
                service_type: { type: 'varchar', enum: ['question', 'assist', 'draw', 'voice', 'video'], description: '服务类型' },
                provider: { type: 'varchar', enum: ['openai', 'anthropic', 'google'], description: '提供商' },
                api_endpoint: { type: 'varchar', description: 'API端点' },
                config_params: { type: 'json', description: '配置参数' },
                status: { type: 'enum', enum: ['active', 'inactive', 'maintenance'], description: '状态' },
                priority: { type: 'int', description: '优先级' },
                cost_per_token: { type: 'decimal', description: '每Token成本' },
                created_at: { type: 'timestamp', description: '创建时间' },
                updated_at: { type: 'timestamp', description: '更新时间' }
            }
        };

        // 测试结果存储
        const testResults = {};
        let providerConfigModule = null;

        // 工具函数
        function displayResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="test-result ${type}">${content}</div>`;
        }

        function formatJSON(obj) {
            return JSON.stringify(obj, null, 2);
        }

        // Test 1: 模块加载测试
        window.testModuleLoading = async function() {
            try {
                displayResult('module-loading-result', '正在加载服务商配置模块...', 'info');
                
                // 尝试从生产环境加载模块
                const ProviderConfigModule = await import('https://ai-pm-admin-v3-prod.vercel.app/_pages/ai-service/provider-config.js');
                const ProviderConfig = ProviderConfigModule.ProviderConfig;
                
                // 模拟app上下文
                const mockApp = {
                    api: {
                        getProviders: () => Promise.resolve({ success: true, providers: {} }),
                        getProviderCatalog: () => Promise.resolve({ providers: [], models: [] }),
                        addProvider: () => Promise.resolve({ success: true }),
                        updateProvider: () => Promise.resolve({ success: true }),
                        deleteProvider: () => Promise.resolve({ success: true }),
                        testProvider: () => Promise.resolve({ success: true })
                    },
                    showToast: (type, message) => console.log(`Toast (${type}): ${message}`)
                };
                
                providerConfigModule = new ProviderConfig(mockApp);
                
                let result = `✅ 服务商配置模块加载成功!\n\n`;
                result += `📋 模块信息:\n`;
                result += `- 类名: ${ProviderConfig.name}\n`;
                result += `- 支持的服务商类型: ${providerConfigModule.providerTypes.length}个\n`;
                result += `- 支持的类型: ${providerConfigModule.providerTypes.join(', ')}\n`;
                result += `- 核心方法: render, loadProviders, saveProvider, editProvider, deleteProvider\n`;
                
                displayResult('module-loading-result', result, 'success');
                testResults.moduleLoading = true;
                
            } catch (error) {
                displayResult('module-loading-result', `❌ 模块加载失败: ${error.message}`, 'error');
                testResults.moduleLoading = false;
            }
        };

        // Test 2: API连接测试
        window.testAPIConnection = async function() {
            if (!providerConfigModule) {
                displayResult('api-connection-result', '❌ 请先运行模块加载测试', 'error');
                return;
            }

            try {
                displayResult('api-connection-result', '正在测试API连接...', 'info');
                
                const loadResult = await providerConfigModule.loadProviders();
                
                let result = `📡 API连接测试结果:\n\n`;
                result += `✅ 连接状态: ${loadResult.success ? '成功' : '失败'}\n`;
                result += `📊 数据源: ${loadResult.offline ? '离线缓存' : loadResult.fallback ? '后备数据' : '在线API'}\n`;
                result += `📋 加载的服务商类型: ${Object.keys(loadResult.providers || {}).length}个\n`;
                
                // 统计服务商数量
                let totalProviders = 0;
                if (loadResult.providers) {
                    Object.values(loadResult.providers).forEach(typeProviders => {
                        if (Array.isArray(typeProviders)) {
                            totalProviders += typeProviders.length;
                        }
                    });
                }
                result += `🤖 服务商配置总数: ${totalProviders}个\n\n`;
                
                // 显示具体的服务商信息
                if (totalProviders > 0) {
                    result += `📋 具体服务商列表:\n`;
                    Object.entries(loadResult.providers || {}).forEach(([type, providers]) => {
                        if (Array.isArray(providers) && providers.length > 0) {
                            result += `  ${type}: ${providers.length}个配置\n`;
                            providers.forEach(provider => {
                                result += `    - ${provider.name} (${provider.enabled ? '启用' : '禁用'})\n`;
                            });
                        }
                    });
                }
                
                displayResult('api-connection-result', result, loadResult.success ? 'success' : 'warning');
                testResults.apiConnection = loadResult.success;

            } catch (error) {
                displayResult('api-connection-result', `❌ API连接测试失败: ${error.message}`, 'error');
                testResults.apiConnection = false;
            }
        };

        // Test 3: 数据库契约验证
        window.testDatabaseContract = async function() {
            if (!providerConfigModule) {
                displayResult('database-contract-result', '❌ 请先运行模块加载测试', 'error');
                return;
            }

            try {
                displayResult('database-contract-result', '正在验证数据库契约合规性...', 'info');
                
                const loadResult = await providerConfigModule.loadProviders();
                const providers = loadResult.providers || {};
                
                let result = `🔍 数据库契约合规性验证:\n\n`;
                
                // 验证AI_SERVICES表契约
                const contractFields = DATABASE_CONTRACT.AI_SERVICES;
                const complianceResults = {};
                
                let totalProviders = 0;
                let compliantProviders = 0;
                
                // 检查每个服务商配置
                Object.entries(providers).forEach(([type, typeProviders]) => {
                    if (Array.isArray(typeProviders)) {
                        typeProviders.forEach(provider => {
                            totalProviders++;
                            let providerCompliance = 0;
                            let totalFields = Object.keys(contractFields).length;
                            
                            // 检查必需字段
                            const fieldChecks = {};
                            
                            // ID字段检查
                            fieldChecks.service_id = provider.id ? '✅' : '❌ 缺失';
                            if (provider.id) providerCompliance++;
                            
                            // 服务名称检查
                            fieldChecks.service_name = provider.name ? '✅' : '❌ 缺失';
                            if (provider.name) providerCompliance++;
                            
                            // 服务类型检查
                            const validTypes = contractFields.service_type.enum;
                            const hasValidType = validTypes.includes(type) || 
                                               (provider.type && validTypes.includes(provider.type));
                            fieldChecks.service_type = hasValidType ? '✅' : `❌ 类型"${type}"不在契约中`;
                            if (hasValidType) providerCompliance++;
                            
                            // 提供商检查
                            const validProviders = contractFields.provider.enum;
                            const hasValidProvider = validProviders.includes(type);
                            fieldChecks.provider = hasValidProvider ? '✅' : `⚠️ 提供商"${type}"需要验证`;
                            if (hasValidProvider) providerCompliance++;
                            
                            // API端点检查
                            fieldChecks.api_endpoint = provider.endpoint !== undefined ? '✅' : '⚠️ 可选字段';
                            providerCompliance++; // 可选字段，给予通过
                            
                            // 配置参数检查
                            const hasConfigParams = provider.models || provider.config_params;
                            fieldChecks.config_params = hasConfigParams ? '✅' : '❌ 缺失';
                            if (hasConfigParams) providerCompliance++;
                            
                            // 状态检查
                            const validStatuses = contractFields.status.enum;
                            const providerStatus = provider.enabled ? 'active' : 'inactive';
                            const hasValidStatus = validStatuses.includes(providerStatus);
                            fieldChecks.status = hasValidStatus ? '✅' : '❌ 状态不合规';
                            if (hasValidStatus) providerCompliance++;
                            
                            // 优先级检查
                            fieldChecks.priority = provider.priority !== undefined ? '✅' : '⚠️ 使用默认值';
                            providerCompliance++; // 有默认值，给予通过
                            
                            // 成本检查
                            fieldChecks.cost_per_token = provider.cost_per_token !== undefined ? '✅' : '❌ 缺失';
                            if (provider.cost_per_token !== undefined) providerCompliance++;
                            
                            // 创建时间检查
                            fieldChecks.created_at = provider.createdAt ? '✅' : '⚠️ 缺失';
                            if (provider.createdAt) providerCompliance++;
                            
                            // 更新时间检查
                            fieldChecks.updated_at = provider.updatedAt ? '✅' : '⚠️ 可自动生成';
                            providerCompliance++; // 可自动生成，给予通过
                            
                            const complianceRate = (providerCompliance / totalFields * 100).toFixed(1);
                            if (complianceRate >= 70) compliantProviders++;
                            
                            complianceResults[`${type}/${provider.id}`] = {
                                name: provider.name,
                                complianceRate,
                                fieldChecks
                            };
                        });
                    }
                });
                
                // 生成结果报告
                const overallCompliance = totalProviders > 0 ? (compliantProviders / totalProviders * 100).toFixed(1) : 0;
                
                result += `📊 总体合规性: ${overallCompliance}% (${compliantProviders}/${totalProviders})\n\n`;
                
                result += `📋 契约字段验证结果:\n`;
                result += `┌─────────────────────┬─────────────────────────────────────┐\n`;
                result += `│ 字段名              │ 契约要求                            │\n`;
                result += `├─────────────────────┼─────────────────────────────────────┤\n`;
                
                Object.entries(contractFields).forEach(([field, spec]) => {
                    const requirement = spec.enum ? 
                        `${spec.type} (${spec.enum.join('|')})` : 
                        spec.type;
                    result += `│ ${field.padEnd(19)} │ ${requirement.padEnd(35)} │\n`;
                });
                result += `└─────────────────────┴─────────────────────────────────────┘\n\n`;
                
                // 显示详细的合规性检查结果
                result += `🔍 详细合规性检查:\n`;
                Object.entries(complianceResults).forEach(([providerKey, compliance]) => {
                    result += `\n📝 ${compliance.name} (${providerKey}):\n`;
                    result += `   合规率: ${compliance.complianceRate}%\n`;
                    Object.entries(compliance.fieldChecks).forEach(([field, status]) => {
                        result += `   ${field}: ${status}\n`;
                    });
                });
                
                const resultType = overallCompliance >= 80 ? 'success' : 
                                 overallCompliance >= 60 ? 'warning' : 'error';
                
                displayResult('database-contract-result', result, resultType);
                testResults.databaseContract = overallCompliance >= 70;

            } catch (error) {
                displayResult('database-contract-result', `❌ 数据库契约验证失败: ${error.message}`, 'error');
                testResults.databaseContract = false;
            }
        };

        // Test 4a: 添加服务商按钮测试
        window.testAddProviderButton = async function() {
            if (!providerConfigModule) {
                displayResult('add-provider-result', '❌ 请先运行模块加载测试', 'error');
                return;
            }

            try {
                displayResult('add-provider-result', '正在测试添加服务商功能...', 'info');
                
                let result = `🧪 添加服务商按钮功能测试:\n\n`;
                
                // 测试showAddDialog方法存在性
                const hasShowAddDialog = typeof providerConfigModule.showAddDialog === 'function';
                result += `✅ showAddDialog方法: ${hasShowAddDialog ? '存在' : '❌ 缺失'}\n`;
                
                // 测试saveProvider方法存在性
                const hasSaveProvider = typeof providerConfigModule.saveProvider === 'function';
                result += `✅ saveProvider方法: ${hasSaveProvider ? '存在' : '❌ 缺失'}\n`;
                
                // 测试generateProviderOptions方法
                const hasGenerateOptions = typeof providerConfigModule.generateProviderOptions === 'function';
                result += `✅ generateProviderOptions方法: ${hasGenerateOptions ? '存在' : '❌ 缺失'}\n`;
                
                // 测试onProviderTypeChange方法
                const hasTypeChange = typeof providerConfigModule.onProviderTypeChange === 'function';
                result += `✅ onProviderTypeChange方法: ${hasTypeChange ? '存在' : '❌ 缺失'}\n`;
                
                // 测试支持的服务商类型
                const supportedTypes = providerConfigModule.providerTypes || [];
                result += `📋 支持的服务商类型: ${supportedTypes.length}个\n`;
                result += `   类型列表: ${supportedTypes.join(', ')}\n`;
                
                // 验证类型名称映射
                const typeNameMappings = {};
                supportedTypes.forEach(type => {
                    typeNameMappings[type] = providerConfigModule.getProviderTypeName(type);
                });
                result += `\n🏷️ 类型名称映射:\n`;
                Object.entries(typeNameMappings).forEach(([type, name]) => {
                    result += `   ${type} → ${name}\n`;
                });
                
                // 功能完整性评分
                const functionalityScore = [
                    hasShowAddDialog,
                    hasSaveProvider,
                    hasGenerateOptions,
                    hasTypeChange,
                    supportedTypes.length > 0
                ].filter(Boolean).length;
                
                const maxScore = 5;
                const completeness = (functionalityScore / maxScore * 100).toFixed(1);
                
                result += `\n📊 功能完整性: ${completeness}% (${functionalityScore}/${maxScore})\n`;
                
                const resultType = completeness >= 80 ? 'success' : 
                                 completeness >= 60 ? 'warning' : 'error';
                
                displayResult('add-provider-result', result, resultType);
                testResults.addProvider = completeness >= 80;

            } catch (error) {
                displayResult('add-provider-result', `❌ 添加服务商测试失败: ${error.message}`, 'error');
                testResults.addProvider = false;
            }
        };

        // Test 4b: 加载服务商测试
        window.testLoadProviders = async function() {
            if (!providerConfigModule) {
                displayResult('load-providers-result', '❌ 请先运行模块加载测试', 'error');
                return;
            }

            try {
                displayResult('load-providers-result', '正在测试服务商加载功能...', 'info');
                
                const startTime = Date.now();
                const loadResult = await providerConfigModule.loadProviders();
                const loadTime = Date.now() - startTime;
                
                let result = `📋 服务商加载功能测试:\n\n`;
                result += `⏱️ 加载时间: ${loadTime}ms\n`;
                result += `✅ 加载状态: ${loadResult.success ? '成功' : '失败'}\n`;
                result += `📊 数据源: ${loadResult.offline ? '离线缓存' : loadResult.fallback ? '后备数据' : '在线API'}\n`;
                
                if (loadResult.success && loadResult.providers) {
                    const providers = loadResult.providers;
                    const typeCount = Object.keys(providers).length;
                    let totalProviders = 0;
                    
                    result += `\n📈 加载结果统计:\n`;
                    result += `   服务商类型数: ${typeCount}\n`;
                    
                    Object.entries(providers).forEach(([type, typeProviders]) => {
                        const count = Array.isArray(typeProviders) ? typeProviders.length : 0;
                        totalProviders += count;
                        result += `   ${type}: ${count}个配置\n`;
                    });
                    
                    result += `   总配置数: ${totalProviders}\n`;
                    
                    // 测试渲染功能
                    const hasRenderTable = typeof providerConfigModule.renderProviderTable === 'function';
                    const hasRenderRow = typeof providerConfigModule.renderProviderRow === 'function';
                    
                    result += `\n🖼️ 渲染功能:\n`;
                    result += `   renderProviderTable: ${hasRenderTable ? '✅' : '❌'}\n`;
                    result += `   renderProviderRow: ${hasRenderRow ? '✅' : '❌'}\n`;
                    
                    if (hasRenderTable && totalProviders > 0) {
                        try {
                            const tableHTML = providerConfigModule.renderProviderTable();
                            const hasTable = tableHTML.includes('<table') && tableHTML.includes('</table>');
                            result += `   表格渲染: ${hasTable ? '✅ 正常' : '❌ 异常'}\n`;
                        } catch (renderError) {
                            result += `   表格渲染: ❌ 错误 - ${renderError.message}\n`;
                        }
                    }
                }
                
                const resultType = loadResult.success ? 'success' : 'warning';
                displayResult('load-providers-result', result, resultType);
                testResults.loadProviders = loadResult.success;

            } catch (error) {
                displayResult('load-providers-result', `❌ 加载服务商测试失败: ${error.message}`, 'error');
                testResults.loadProviders = false;
            }
        };

        // Test 4c: 编辑服务商测试
        window.testEditProviderButton = async function() {
            if (!providerConfigModule) {
                displayResult('edit-provider-result', '❌ 请先运行模块加载测试', 'error');
                return;
            }

            try {
                displayResult('edit-provider-result', '正在测试编辑服务商功能...', 'info');
                
                let result = `✏️ 编辑服务商功能测试:\n\n`;
                
                // 测试编辑相关方法
                const hasEditProvider = typeof providerConfigModule.editProvider === 'function';
                const hasUpdateProvider = typeof providerConfigModule.updateProvider === 'function';
                const hasFindProviderById = typeof providerConfigModule.findProviderById === 'function';
                
                result += `📋 编辑功能方法检查:\n`;
                result += `   editProvider: ${hasEditProvider ? '✅' : '❌'}\n`;
                result += `   updateProvider: ${hasUpdateProvider ? '✅' : '❌'}\n`;
                result += `   findProviderById: ${hasFindProviderById ? '✅' : '❌'}\n`;
                
                // 测试查找功能
                const loadResult = await providerConfigModule.loadProviders();
                if (loadResult.success && loadResult.providers) {
                    result += `\n🔍 查找功能测试:\n`;
                    
                    let testProvider = null;
                    let testType = null;
                    
                    // 找到第一个可用的服务商进行测试
                    for (const [type, providers] of Object.entries(loadResult.providers)) {
                        if (Array.isArray(providers) && providers.length > 0) {
                            testProvider = providers[0];
                            testType = type;
                            break;
                        }
                    }
                    
                    if (testProvider && hasFindProviderById) {
                        const foundProvider = providerConfigModule.findProviderById(testType, testProvider.id);
                        result += `   查找测试: ${foundProvider ? '✅ 成功' : '❌ 失败'}\n`;
                        result += `   测试对象: ${testProvider.name} (${testType})\n`;
                    } else {
                        result += `   查找测试: ⚠️ 无测试数据\n`;
                    }
                }
                
                // 功能完整性评分
                const editFunctionality = [
                    hasEditProvider,
                    hasUpdateProvider,
                    hasFindProviderById
                ].filter(Boolean).length;
                
                const completeness = (editFunctionality / 3 * 100).toFixed(1);
                result += `\n📊 编辑功能完整性: ${completeness}%\n`;
                
                const resultType = completeness >= 80 ? 'success' : 
                                 completeness >= 60 ? 'warning' : 'error';
                
                displayResult('edit-provider-result', result, resultType);
                testResults.editProvider = completeness >= 80;

            } catch (error) {
                displayResult('edit-provider-result', `❌ 编辑服务商测试失败: ${error.message}`, 'error');
                testResults.editProvider = false;
            }
        };

        // Test 4d: 删除服务商测试
        window.testDeleteProviderButton = async function() {
            if (!providerConfigModule) {
                displayResult('delete-provider-result', '❌ 请先运行模块加载测试', 'error');
                return;
            }

            try {
                displayResult('delete-provider-result', '正在测试删除服务商功能...', 'info');
                
                let result = `🗑️ 删除服务商功能测试:\n\n`;
                
                // 测试删除方法
                const hasDeleteProvider = typeof providerConfigModule.deleteProvider === 'function';
                result += `📋 删除功能方法检查:\n`;
                result += `   deleteProvider: ${hasDeleteProvider ? '✅' : '❌'}\n`;
                
                // 测试刷新功能
                const hasRefreshProviders = typeof providerConfigModule.refreshProviders === 'function';
                result += `   refreshProviders: ${hasRefreshProviders ? '✅' : '❌'}\n`;
                
                // 测试localStorage清理能力（模拟测试）
                try {
                    const testKey = 'admin_providers_test';
                    localStorage.setItem(testKey, JSON.stringify({ test: true }));
                    const canWrite = localStorage.getItem(testKey) !== null;
                    localStorage.removeItem(testKey);
                    result += `   localStorage操作: ${canWrite ? '✅' : '❌'}\n`;
                } catch (storageError) {
                    result += `   localStorage操作: ❌ 错误\n`;
                }
                
                // 安全性检查
                result += `\n🔒 安全性检查:\n`;
                
                // 检查是否有确认对话框机制
                const deleteMethodSource = hasDeleteProvider ? 
                    providerConfigModule.deleteProvider.toString() : '';
                const hasConfirmDialog = deleteMethodSource.includes('confirm');
                result += `   删除确认对话框: ${hasConfirmDialog ? '✅' : '❌ 缺失'}\n`;
                
                // 检查错误处理
                const hasErrorHandling = deleteMethodSource.includes('try') && 
                                       deleteMethodSource.includes('catch');
                result += `   错误处理机制: ${hasErrorHandling ? '✅' : '❌ 缺失'}\n`;
                
                // 功能完整性评分
                const deleteFunctionality = [
                    hasDeleteProvider,
                    hasRefreshProviders,
                    hasConfirmDialog,
                    hasErrorHandling
                ].filter(Boolean).length;
                
                const completeness = (deleteFunctionality / 4 * 100).toFixed(1);
                result += `\n📊 删除功能完整性: ${completeness}%\n`;
                
                const resultType = completeness >= 75 ? 'success' : 
                                 completeness >= 50 ? 'warning' : 'error';
                
                displayResult('delete-provider-result', result, resultType);
                testResults.deleteProvider = completeness >= 75;

            } catch (error) {
                displayResult('delete-provider-result', `❌ 删除服务商测试失败: ${error.message}`, 'error');
                testResults.deleteProvider = false;
            }
        };

        // Test 5a: 启用/禁用按钮测试
        window.testToggleProviderButton = async function() {
            if (!providerConfigModule) {
                displayResult('toggle-provider-result', '❌ 请先运行模块加载测试', 'error');
                return;
            }

            try {
                displayResult('toggle-provider-result', '正在测试启用/禁用功能...', 'info');
                
                let result = `🔄 启用/禁用功能测试:\n\n`;
                
                // 测试切换方法
                const hasToggleProvider = typeof providerConfigModule.toggleProvider === 'function';
                result += `📋 切换功能方法检查:\n`;
                result += `   toggleProvider: ${hasToggleProvider ? '✅' : '❌'}\n`;
                
                // 测试状态管理
                const loadResult = await providerConfigModule.loadProviders();
                if (loadResult.success && loadResult.providers) {
                    let enabledCount = 0;
                    let disabledCount = 0;
                    let totalCount = 0;
                    
                    Object.values(loadResult.providers).forEach(providers => {
                        if (Array.isArray(providers)) {
                            providers.forEach(provider => {
                                totalCount++;
                                if (provider.enabled) {
                                    enabledCount++;
                                } else {
                                    disabledCount++;
                                }
                            });
                        }
                    });
                    
                    result += `\n📊 当前状态统计:\n`;
                    result += `   总配置数: ${totalCount}\n`;
                    result += `   启用配置: ${enabledCount}\n`;
                    result += `   禁用配置: ${disabledCount}\n`;
                    
                    // 状态字段一致性检查
                    const hasConsistentStatus = totalCount > 0;
                    result += `   状态字段一致性: ${hasConsistentStatus ? '✅' : '⚠️ 无数据'}\n`;
                }
                
                // 检查渲染中的状态显示
                if (typeof providerConfigModule.renderProviderRow === 'function') {
                    const sampleProvider = {
                        id: 'test',
                        name: 'Test Provider',
                        type: 'openai',
                        enabled: true,
                        models: ['gpt-4'],
                        createdAt: new Date().toISOString()
                    };
                    
                    try {
                        const rowHTML = providerConfigModule.renderProviderRow(sampleProvider);
                        const hasStatusDisplay = rowHTML.includes('status-active') || 
                                               rowHTML.includes('status-inactive');
                        const hasToggleButton = rowHTML.includes('toggleProvider');
                        
                        result += `\n🖼️ 渲染状态检查:\n`;
                        result += `   状态显示: ${hasStatusDisplay ? '✅' : '❌'}\n`;
                        result += `   切换按钮: ${hasToggleButton ? '✅' : '❌'}\n`;
                    } catch (renderError) {
                        result += `\n🖼️ 渲染状态检查: ❌ 渲染错误\n`;
                    }
                }
                
                // 功能完整性评分
                const toggleFunctionality = [
                    hasToggleProvider,
                    loadResult.success,
                ].filter(Boolean).length;
                
                const completeness = (toggleFunctionality / 2 * 100).toFixed(1);
                result += `\n📊 切换功能完整性: ${completeness}%\n`;
                
                const resultType = completeness >= 80 ? 'success' : 
                                 completeness >= 60 ? 'warning' : 'error';
                
                displayResult('toggle-provider-result', result, resultType);
                testResults.toggleProvider = completeness >= 80;

            } catch (error) {
                displayResult('toggle-provider-result', `❌ 启用/禁用测试失败: ${error.message}`, 'error');
                testResults.toggleProvider = false;
            }
        };

        // Test 5b: 连接测试按钮测试
        window.testConnectionButton = async function() {
            if (!providerConfigModule) {
                displayResult('test-connection-result', '❌ 请先运行模块加载测试', 'error');
                return;
            }

            try {
                displayResult('test-connection-result', '正在测试连接测试功能...', 'info');
                
                let result = `🧪 连接测试功能测试:\n\n`;
                
                // 测试连接测试方法
                const hasTestProvider = typeof providerConfigModule.testProvider === 'function';
                result += `📋 连接测试方法检查:\n`;
                result += `   testProvider: ${hasTestProvider ? '✅' : '❌'}\n`;
                
                if (hasTestProvider) {
                    // 检查测试方法的实现
                    const testMethodSource = providerConfigModule.testProvider.toString();
                    
                    // 检查是否有API调用
                    const hasAPICall = testMethodSource.includes('api.testProvider') || 
                                     testMethodSource.includes('testProvider');
                    result += `   API调用实现: ${hasAPICall ? '✅' : '❌'}\n`;
                    
                    // 检查是否有后备测试机制
                    const hasFallback = testMethodSource.includes('fallback') || 
                                      testMethodSource.includes('simulate');
                    result += `   后备测试机制: ${hasFallback ? '✅' : '❌'}\n`;
                    
                    // 检查是否有用户反馈
                    const hasUserFeedback = testMethodSource.includes('showToast') || 
                                          testMethodSource.includes('Toast');
                    result += `   用户反馈机制: ${hasUserFeedback ? '✅' : '❌'}\n`;
                    
                    // 检查错误处理
                    const hasErrorHandling = testMethodSource.includes('try') && 
                                           testMethodSource.includes('catch');
                    result += `   错误处理: ${hasErrorHandling ? '✅' : '❌'}\n`;
                }
                
                // 检查渲染中的测试按钮
                const loadResult = await providerConfigModule.loadProviders();
                if (loadResult.success && loadResult.providers) {
                    // 找一个测试对象
                    let hasTestButton = false;
                    
                    for (const [type, providers] of Object.entries(loadResult.providers)) {
                        if (Array.isArray(providers) && providers.length > 0) {
                            try {
                                const rowHTML = providerConfigModule.renderProviderRow(providers[0]);
                                hasTestButton = rowHTML.includes('testProvider') && 
                                              rowHTML.includes('🧪');
                                break;
                            } catch (e) {
                                // 继续测试下一个
                            }
                        }
                    }
                    
                    result += `\n🖼️ UI按钮检查:\n`;
                    result += `   测试按钮渲染: ${hasTestButton ? '✅' : '❌'}\n`;
                }
                
                // 功能完整性评分
                const testFunctionality = [
                    hasTestProvider,
                    testMethodSource && testMethodSource.includes('api'),
                    testMethodSource && testMethodSource.includes('catch'),
                ].filter(Boolean).length;
                
                const completeness = (testFunctionality / 3 * 100).toFixed(1);
                result += `\n📊 连接测试功能完整性: ${completeness}%\n`;
                
                const resultType = completeness >= 70 ? 'success' : 
                                 completeness >= 50 ? 'warning' : 'error';
                
                displayResult('test-connection-result', result, resultType);
                testResults.testConnection = completeness >= 70;

            } catch (error) {
                displayResult('test-connection-result', `❌ 连接测试功能测试失败: ${error.message}`, 'error');
                testResults.testConnection = false;
            }
        };

        // Test 6: 数据验证和安全测试
        window.testDataValidation = async function() {
            if (!providerConfigModule) {
                displayResult('data-validation-result', '❌ 请先运行模块加载测试', 'error');
                return;
            }

            try {
                displayResult('data-validation-result', '正在测试数据验证和安全机制...', 'info');
                
                let result = `🔒 数据验证和安全测试:\n\n`;
                
                // 测试保存方法的验证机制
                if (typeof providerConfigModule.saveProvider === 'function') {
                    const saveMethodSource = providerConfigModule.saveProvider.toString();
                    
                    result += `📋 保存数据验证检查:\n`;
                    
                    // 必填字段验证
                    const hasRequiredValidation = saveMethodSource.includes('required') || 
                                                 saveMethodSource.includes('!type') || 
                                                 saveMethodSource.includes('!data.name');
                    result += `   必填字段验证: ${hasRequiredValidation ? '✅' : '❌'}\n`;
                    
                    // API密钥验证
                    const hasApiKeyValidation = saveMethodSource.includes('apiKey') && 
                                               (saveMethodSource.includes('!data.apiKey') || 
                                                saveMethodSource.includes('apiKey.length'));
                    result += `   API密钥验证: ${hasApiKeyValidation ? '✅' : '❌'}\n`;
                    
                    // 模型验证
                    const hasModelValidation = saveMethodSource.includes('models') && 
                                              saveMethodSource.includes('length');
                    result += `   模型选择验证: ${hasModelValidation ? '✅' : '❌'}\n`;
                    
                    // 错误消息显示
                    const hasErrorMessages = saveMethodSource.includes('showToast') && 
                                           saveMethodSource.includes('error');
                    result += `   错误消息显示: ${hasErrorMessages ? '✅' : '❌'}\n`;
                }
                
                // 测试数据清理和过滤
                result += `\n🧹 数据清理机制:\n`;
                
                // 检查是否有数据过滤
                const hasDataFiltering = providerConfigModule.providerTypes && 
                                        Array.isArray(providerConfigModule.providerTypes);
                result += `   服务商类型过滤: ${hasDataFiltering ? '✅' : '❌'}\n`;
                
                // 检查API密钥掩码
                if (typeof providerConfigModule.renderProviderRow === 'function') {
                    const testProvider = {
                        id: 1,
                        name: 'Test',
                        type: 'openai',
                        apiKey: 'sk-1234567890abcdef',
                        enabled: true,
                        models: ['gpt-4']
                    };
                    
                    try {
                        const rowHTML = providerConfigModule.renderProviderRow(testProvider);
                        const hasMaskedKey = rowHTML.includes('****') || 
                                           rowHTML.includes('masked') ||
                                           !rowHTML.includes('sk-1234567890abcdef');
                        result += `   API密钥掩码: ${hasMaskedKey ? '✅' : '❌ 可能泄露'}\n`;
                    } catch (e) {
                        result += `   API密钥掩码: ❌ 渲染错误\n`;
                    }
                }
                
                // 安全性检查
                result += `\n🛡️ 安全性检查:\n`;
                
                // 检查localStorage使用安全性
                const moduleSource = providerConfigModule.constructor.toString() + 
                                   (providerConfigModule.saveProvider ? 
                                    providerConfigModule.saveProvider.toString() : '');
                
                const hasSecureStorage = moduleSource.includes('JSON.stringify') && 
                                       !moduleSource.includes('eval');
                result += `   安全存储机制: ${hasSecureStorage ? '✅' : '⚠️'}\n`;
                
                // 检查XSS防护
                const hasXSSProtection = !moduleSource.includes('innerHTML =') || 
                                        moduleSource.includes('textContent');
                result += `   XSS防护: ${hasXSSProtection ? '✅' : '⚠️ 需要检查'}\n`;
                
                // 功能完整性评分
                const validationFeatures = [
                    hasRequiredValidation,
                    hasApiKeyValidation,
                    hasModelValidation,
                    hasErrorMessages,
                    hasDataFiltering
                ].filter(Boolean).length;
                
                const completeness = (validationFeatures / 5 * 100).toFixed(1);
                result += `\n📊 数据验证完整性: ${completeness}%\n`;
                
                const resultType = completeness >= 80 ? 'success' : 
                                 completeness >= 60 ? 'warning' : 'error';
                
                displayResult('data-validation-result', result, resultType);
                testResults.dataValidation = completeness >= 70;

            } catch (error) {
                displayResult('data-validation-result', `❌ 数据验证测试失败: ${error.message}`, 'error');
                testResults.dataValidation = false;
            }
        };

        // Test 7: 错误处理测试
        window.testErrorHandling = async function() {
            if (!providerConfigModule) {
                displayResult('error-handling-result', '❌ 请先运行模块加载测试', 'error');
                return;
            }

            try {
                displayResult('error-handling-result', '正在测试错误处理机制...', 'info');
                
                let result = `⚠️ 错误处理机制测试:\n\n`;
                
                // 测试渲染错误状态
                const hasRenderErrorState = typeof providerConfigModule.renderErrorState === 'function';
                result += `📋 错误状态渲染:\n`;
                result += `   renderErrorState: ${hasRenderErrorState ? '✅' : '❌'}\n`;
                
                if (hasRenderErrorState) {
                    try {
                        const errorHTML = providerConfigModule.renderErrorState('测试错误信息');
                        const hasErrorIcon = errorHTML.includes('⚠️') || errorHTML.includes('error');
                        const hasReloadButton = errorHTML.includes('重新加载') || errorHTML.includes('reload');
                        
                        result += `   错误图标显示: ${hasErrorIcon ? '✅' : '❌'}\n`;
                        result += `   重新加载按钮: ${hasReloadButton ? '✅' : '❌'}\n`;
                    } catch (e) {
                        result += `   错误渲染测试: ❌ 渲染失败\n`;
                    }
                }
                
                // 测试空状态渲染
                const hasRenderEmptyState = typeof providerConfigModule.renderEmptyState === 'function';
                result += `\n📭 空状态处理:\n`;
                result += `   renderEmptyState: ${hasRenderEmptyState ? '✅' : '❌'}\n`;
                
                if (hasRenderEmptyState) {
                    try {
                        const emptyHTML = providerConfigModule.renderEmptyState();
                        const hasEmptyIcon = emptyHTML.includes('📭') || emptyHTML.includes('empty');
                        const hasAddButton = emptyHTML.includes('添加') || emptyHTML.includes('showAddDialog');
                        
                        result += `   空状态图标: ${hasEmptyIcon ? '✅' : '❌'}\n`;
                        result += `   添加引导: ${hasAddButton ? '✅' : '❌'}\n`;
                    } catch (e) {
                        result += `   空状态渲染测试: ❌ 渲染失败\n`;
                    }
                }
                
                // 测试方法的错误处理
                result += `\n🛠️ 方法错误处理检查:\n`;
                
                const methods = [
                    'loadProviders',
                    'saveProvider', 
                    'updateProvider',
                    'deleteProvider',
                    'testProvider'
                ];
                
                let methodsWithErrorHandling = 0;
                
                methods.forEach(methodName => {
                    if (typeof providerConfigModule[methodName] === 'function') {
                        const methodSource = providerConfigModule[methodName].toString();
                        const hasTryCatch = methodSource.includes('try') && methodSource.includes('catch');
                        const hasErrorLog = methodSource.includes('console.error') || 
                                          methodSource.includes('console.warn');
                        const hasUserFeedback = methodSource.includes('showToast');
                        
                        if (hasTryCatch || hasErrorLog) {
                            methodsWithErrorHandling++;
                        }
                        
                        result += `   ${methodName}: ${hasTryCatch ? '✅ try/catch' : '❌'} `;
                        result += `${hasErrorLog ? '✅ 日志' : '❌'} `;
                        result += `${hasUserFeedback ? '✅ 反馈' : '❌'}\n`;
                    }
                });
                
                // 测试降级机制
                result += `\n🔄 降级机制检查:\n`;
                
                const loadProviderSource = providerConfigModule.loadProviders ? 
                    providerConfigModule.loadProviders.toString() : '';
                
                const hasAPIFallback = loadProviderSource.includes('localStorage') && 
                                     loadProviderSource.includes('fallback');
                result += `   API降级到缓存: ${hasAPIFallback ? '✅' : '❌'}\n`;
                
                const hasOfflineMode = loadProviderSource.includes('offline') || 
                                     loadProviderSource.includes('cached');
                result += `   离线模式支持: ${hasOfflineMode ? '✅' : '❌'}\n`;
                
                const hasStatusIndicator = providerConfigModule.render ? 
                    providerConfigModule.render.toString().includes('status-indicator') : false;
                result += `   状态指示器: ${hasStatusIndicator ? '✅' : '❌'}\n`;
                
                // 功能完整性评分
                const errorHandlingFeatures = [
                    hasRenderErrorState,
                    hasRenderEmptyState,
                    methodsWithErrorHandling >= methods.length / 2,
                    hasAPIFallback,
                    hasOfflineMode,
                    hasStatusIndicator
                ].filter(Boolean).length;
                
                const completeness = (errorHandlingFeatures / 6 * 100).toFixed(1);
                result += `\n📊 错误处理完整性: ${completeness}%\n`;
                result += `错误处理方法覆盖率: ${methodsWithErrorHandling}/${methods.length}\n`;
                
                const resultType = completeness >= 75 ? 'success' : 
                                 completeness >= 50 ? 'warning' : 'error';
                
                displayResult('error-handling-result', result, resultType);
                testResults.errorHandling = completeness >= 70;

            } catch (error) {
                displayResult('error-handling-result', `❌ 错误处理测试失败: ${error.message}`, 'error');
                testResults.errorHandling = false;
            }
        };

        // 运行所有测试
        window.runAllTests = async function() {
            displayResult('final-result', '🔄 正在运行所有测试...', 'info');
            
            // 按顺序运行所有测试
            await testModuleLoading();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testAPIConnection();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testDatabaseContract();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testAddProviderButton();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testLoadProviders();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testEditProviderButton();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testDeleteProviderButton();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testToggleProviderButton();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testConnectionButton();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testDataValidation();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testErrorHandling();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // 计算最终结果
            const totalTests = Object.keys(testResults).length;
            const passedTests = Object.values(testResults).filter(result => result === true).length;
            const successRate = totalTests > 0 ? ((passedTests / totalTests) * 100).toFixed(1) : 0;
            
            let finalResult = `🎯 服务商配置全面测试完成!\n\n`;
            finalResult += `📊 测试结果统计:\n`;
            finalResult += `  • 总测试数: ${totalTests}\n`;
            finalResult += `  • 通过测试: ${passedTests}\n`;
            finalResult += `  • 失败测试: ${totalTests - passedTests}\n`;
            finalResult += `  • 成功率: ${successRate}%\n\n`;
            
            finalResult += `📋 详细结果:\n`;
            const testNames = {
                moduleLoading: '模块加载',
                apiConnection: 'API连接',
                databaseContract: '数据库契约',
                addProvider: '添加服务商',
                loadProviders: '加载服务商',
                editProvider: '编辑服务商',
                deleteProvider: '删除服务商',
                toggleProvider: '启用/禁用',
                testConnection: '连接测试',
                dataValidation: '数据验证',
                errorHandling: '错误处理'
            };
            
            Object.entries(testResults).forEach(([test, result]) => {
                const testName = testNames[test] || test;
                finalResult += `  • ${testName}: ${result ? '✅ 通过' : '❌ 失败'}\n`;
            });
            
            // 生成建议
            finalResult += `\n💡 改进建议:\n`;
            
            if (successRate >= 90) {
                finalResult += `🎉 服务商配置功能优秀，所有按钮功能和数据库契约都符合要求！`;
            } else if (successRate >= 75) {
                finalResult += `✅ 服务商配置功能良好，建议修复失败的测试项目以达到完美状态。`;
            } else if (successRate >= 60) {
                finalResult += `⚠️ 服务商配置功能基本可用，但存在一些问题需要修复：\n`;
                Object.entries(testResults).forEach(([test, result]) => {
                    if (!result) {
                        const testName = testNames[test] || test;
                        finalResult += `  - 修复${testName}功能\n`;
                    }
                });
            } else {
                finalResult += `❌ 服务商配置功能存在严重问题，需要立即修复：\n`;
                Object.entries(testResults).forEach(([test, result]) => {
                    if (!result) {
                        const testName = testNames[test] || test;
                        finalResult += `  - 紧急修复${testName}功能\n`;
                    }
                });
            }
            
            const resultType = successRate >= 80 ? 'success' : 
                             successRate >= 60 ? 'warning' : 'error';
            
            displayResult('final-result', `<div class="json-display">${finalResult}</div>`, resultType);
        };
    </script>
</body>
</html>