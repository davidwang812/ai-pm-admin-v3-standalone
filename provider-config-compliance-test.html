<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§ª æœåŠ¡å•†é…ç½®åŠŸèƒ½ä¸æ•°æ®åº“å¥‘çº¦æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .test-result {
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .json-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            overflow-x: auto;
            max-height: 300px;
            overflow-y: auto;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin: 2px;
        }
        .compliant {
            background: #28a745;
            color: white;
        }
        .non-compliant {
            background: #dc3545;
            color: white;
        }
        .partial {
            background: #ffc107;
            color: #212529;
        }
        .contract-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .contract-table th,
        .contract-table td {
            border: 1px solid #dee2e6;
            padding: 8px 12px;
            text-align: left;
        }
        .contract-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        .flex-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .flex-item {
            flex: 1;
            min-width: 300px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§ª æœåŠ¡å•†é…ç½®åŠŸèƒ½ä¸æ•°æ®åº“å¥‘çº¦æµ‹è¯•</h1>
            <p>å…¨é¢æµ‹è¯•AIæœåŠ¡å•†é…ç½®çš„æ‰€æœ‰æŒ‰é’®åŠŸèƒ½å’Œæ•°æ®åº“å¥‘çº¦åˆè§„æ€§</p>
        </div>

        <div class="test-section">
            <h3>ğŸ“‹ Test 1: æœåŠ¡å•†é…ç½®æ¨¡å—åŠ è½½æµ‹è¯•</h3>
            <button onclick="testModuleLoading()">æµ‹è¯•æ¨¡å—åŠ è½½</button>
            <div id="module-loading-result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ”— Test 2: APIè¿æ¥å’Œæ•°æ®åŠ è½½æµ‹è¯•</h3>
            <button onclick="testAPIConnection()">æµ‹è¯•APIè¿æ¥</button>
            <div id="api-connection-result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š Test 3: æ•°æ®åº“å¥‘çº¦åˆè§„æ€§éªŒè¯</h3>
            <button onclick="testDatabaseContract()">éªŒè¯æ•°æ®åº“å¥‘çº¦</button>
            <div id="database-contract-result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ¯ Test 4: CRUDæ“ä½œæŒ‰é’®åŠŸèƒ½æµ‹è¯•</h3>
            <div class="flex-container">
                <div class="flex-item">
                    <h4>åˆ›å»ºæ“ä½œ</h4>
                    <button onclick="testAddProviderButton()">æµ‹è¯•æ·»åŠ æœåŠ¡å•†</button>
                    <div id="add-provider-result"></div>
                </div>
                <div class="flex-item">
                    <h4>è¯»å–æ“ä½œ</h4>
                    <button onclick="testLoadProviders()">æµ‹è¯•åŠ è½½æœåŠ¡å•†</button>
                    <div id="load-providers-result"></div>
                </div>
            </div>
            <div class="flex-container">
                <div class="flex-item">
                    <h4>æ›´æ–°æ“ä½œ</h4>
                    <button onclick="testEditProviderButton()">æµ‹è¯•ç¼–è¾‘æœåŠ¡å•†</button>
                    <div id="edit-provider-result"></div>
                </div>
                <div class="flex-item">
                    <h4>åˆ é™¤æ“ä½œ</h4>
                    <button onclick="testDeleteProviderButton()">æµ‹è¯•åˆ é™¤æœåŠ¡å•†</button>
                    <div id="delete-provider-result"></div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>âš™ï¸ Test 5: æœåŠ¡å•†æ“ä½œæŒ‰é’®åŠŸèƒ½æµ‹è¯•</h3>
            <div class="flex-container">
                <div class="flex-item">
                    <button onclick="testToggleProviderButton()">æµ‹è¯•å¯ç”¨/ç¦ç”¨æŒ‰é’®</button>
                    <div id="toggle-provider-result"></div>
                </div>
                <div class="flex-item">
                    <button onclick="testConnectionButton()">æµ‹è¯•è¿æ¥æµ‹è¯•æŒ‰é’®</button>
                    <div id="test-connection-result"></div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ”’ Test 6: æ•°æ®éªŒè¯å’Œå®‰å…¨æµ‹è¯•</h3>
            <button onclick="testDataValidation()">æµ‹è¯•æ•°æ®éªŒè¯</button>
            <div id="data-validation-result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“ˆ Test 7: ç”¨æˆ·ä½“éªŒå’Œé”™è¯¯å¤„ç†æµ‹è¯•</h3>
            <button onclick="testErrorHandling()">æµ‹è¯•é”™è¯¯å¤„ç†</button>
            <div id="error-handling-result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ¯ æœ€ç»ˆæµ‹è¯•ç»“æœ</h3>
            <button onclick="runAllTests()">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
            <div id="final-result"></div>
        </div>
    </div>

    <script type="module">
        // æ•°æ®åº“å¥‘çº¦å®šä¹‰
        const DATABASE_CONTRACT = {
            AI_SERVICES: {
                service_id: { type: 'bigint', constraint: 'PK', description: 'æœåŠ¡ID' },
                service_name: { type: 'varchar', constraint: 'UK', description: 'æœåŠ¡åç§°' },
                service_type: { type: 'varchar', enum: ['question', 'assist', 'draw', 'voice', 'video'], description: 'æœåŠ¡ç±»å‹' },
                provider: { type: 'varchar', enum: ['openai', 'anthropic', 'google'], description: 'æä¾›å•†' },
                api_endpoint: { type: 'varchar', description: 'APIç«¯ç‚¹' },
                config_params: { type: 'json', description: 'é…ç½®å‚æ•°' },
                status: { type: 'enum', enum: ['active', 'inactive', 'maintenance'], description: 'çŠ¶æ€' },
                priority: { type: 'int', description: 'ä¼˜å…ˆçº§' },
                cost_per_token: { type: 'decimal', description: 'æ¯Tokenæˆæœ¬' },
                created_at: { type: 'timestamp', description: 'åˆ›å»ºæ—¶é—´' },
                updated_at: { type: 'timestamp', description: 'æ›´æ–°æ—¶é—´' }
            }
        };

        // æµ‹è¯•ç»“æœå­˜å‚¨
        const testResults = {};
        let providerConfigModule = null;

        // å·¥å…·å‡½æ•°
        function displayResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="test-result ${type}">${content}</div>`;
        }

        function formatJSON(obj) {
            return JSON.stringify(obj, null, 2);
        }

        // Test 1: æ¨¡å—åŠ è½½æµ‹è¯•
        window.testModuleLoading = async function() {
            try {
                displayResult('module-loading-result', 'æ­£åœ¨åŠ è½½æœåŠ¡å•†é…ç½®æ¨¡å—...', 'info');
                
                // å°è¯•ä»ç”Ÿäº§ç¯å¢ƒåŠ è½½æ¨¡å—
                const ProviderConfigModule = await import('https://ai-pm-admin-v3-prod.vercel.app/_pages/ai-service/provider-config.js');
                const ProviderConfig = ProviderConfigModule.ProviderConfig;
                
                // æ¨¡æ‹Ÿappä¸Šä¸‹æ–‡
                const mockApp = {
                    api: {
                        getProviders: () => Promise.resolve({ success: true, providers: {} }),
                        getProviderCatalog: () => Promise.resolve({ providers: [], models: [] }),
                        addProvider: () => Promise.resolve({ success: true }),
                        updateProvider: () => Promise.resolve({ success: true }),
                        deleteProvider: () => Promise.resolve({ success: true }),
                        testProvider: () => Promise.resolve({ success: true })
                    },
                    showToast: (type, message) => console.log(`Toast (${type}): ${message}`)
                };
                
                providerConfigModule = new ProviderConfig(mockApp);
                
                let result = `âœ… æœåŠ¡å•†é…ç½®æ¨¡å—åŠ è½½æˆåŠŸ!\n\n`;
                result += `ğŸ“‹ æ¨¡å—ä¿¡æ¯:\n`;
                result += `- ç±»å: ${ProviderConfig.name}\n`;
                result += `- æ”¯æŒçš„æœåŠ¡å•†ç±»å‹: ${providerConfigModule.providerTypes.length}ä¸ª\n`;
                result += `- æ”¯æŒçš„ç±»å‹: ${providerConfigModule.providerTypes.join(', ')}\n`;
                result += `- æ ¸å¿ƒæ–¹æ³•: render, loadProviders, saveProvider, editProvider, deleteProvider\n`;
                
                displayResult('module-loading-result', result, 'success');
                testResults.moduleLoading = true;
                
            } catch (error) {
                displayResult('module-loading-result', `âŒ æ¨¡å—åŠ è½½å¤±è´¥: ${error.message}`, 'error');
                testResults.moduleLoading = false;
            }
        };

        // Test 2: APIè¿æ¥æµ‹è¯•
        window.testAPIConnection = async function() {
            if (!providerConfigModule) {
                displayResult('api-connection-result', 'âŒ è¯·å…ˆè¿è¡Œæ¨¡å—åŠ è½½æµ‹è¯•', 'error');
                return;
            }

            try {
                displayResult('api-connection-result', 'æ­£åœ¨æµ‹è¯•APIè¿æ¥...', 'info');
                
                const loadResult = await providerConfigModule.loadProviders();
                
                let result = `ğŸ“¡ APIè¿æ¥æµ‹è¯•ç»“æœ:\n\n`;
                result += `âœ… è¿æ¥çŠ¶æ€: ${loadResult.success ? 'æˆåŠŸ' : 'å¤±è´¥'}\n`;
                result += `ğŸ“Š æ•°æ®æº: ${loadResult.offline ? 'ç¦»çº¿ç¼“å­˜' : loadResult.fallback ? 'åå¤‡æ•°æ®' : 'åœ¨çº¿API'}\n`;
                result += `ğŸ“‹ åŠ è½½çš„æœåŠ¡å•†ç±»å‹: ${Object.keys(loadResult.providers || {}).length}ä¸ª\n`;
                
                // ç»Ÿè®¡æœåŠ¡å•†æ•°é‡
                let totalProviders = 0;
                if (loadResult.providers) {
                    Object.values(loadResult.providers).forEach(typeProviders => {
                        if (Array.isArray(typeProviders)) {
                            totalProviders += typeProviders.length;
                        }
                    });
                }
                result += `ğŸ¤– æœåŠ¡å•†é…ç½®æ€»æ•°: ${totalProviders}ä¸ª\n\n`;
                
                // æ˜¾ç¤ºå…·ä½“çš„æœåŠ¡å•†ä¿¡æ¯
                if (totalProviders > 0) {
                    result += `ğŸ“‹ å…·ä½“æœåŠ¡å•†åˆ—è¡¨:\n`;
                    Object.entries(loadResult.providers || {}).forEach(([type, providers]) => {
                        if (Array.isArray(providers) && providers.length > 0) {
                            result += `  ${type}: ${providers.length}ä¸ªé…ç½®\n`;
                            providers.forEach(provider => {
                                result += `    - ${provider.name} (${provider.enabled ? 'å¯ç”¨' : 'ç¦ç”¨'})\n`;
                            });
                        }
                    });
                }
                
                displayResult('api-connection-result', result, loadResult.success ? 'success' : 'warning');
                testResults.apiConnection = loadResult.success;

            } catch (error) {
                displayResult('api-connection-result', `âŒ APIè¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                testResults.apiConnection = false;
            }
        };

        // Test 3: æ•°æ®åº“å¥‘çº¦éªŒè¯
        window.testDatabaseContract = async function() {
            if (!providerConfigModule) {
                displayResult('database-contract-result', 'âŒ è¯·å…ˆè¿è¡Œæ¨¡å—åŠ è½½æµ‹è¯•', 'error');
                return;
            }

            try {
                displayResult('database-contract-result', 'æ­£åœ¨éªŒè¯æ•°æ®åº“å¥‘çº¦åˆè§„æ€§...', 'info');
                
                const loadResult = await providerConfigModule.loadProviders();
                const providers = loadResult.providers || {};
                
                let result = `ğŸ” æ•°æ®åº“å¥‘çº¦åˆè§„æ€§éªŒè¯:\n\n`;
                
                // éªŒè¯AI_SERVICESè¡¨å¥‘çº¦
                const contractFields = DATABASE_CONTRACT.AI_SERVICES;
                const complianceResults = {};
                
                let totalProviders = 0;
                let compliantProviders = 0;
                
                // æ£€æŸ¥æ¯ä¸ªæœåŠ¡å•†é…ç½®
                Object.entries(providers).forEach(([type, typeProviders]) => {
                    if (Array.isArray(typeProviders)) {
                        typeProviders.forEach(provider => {
                            totalProviders++;
                            let providerCompliance = 0;
                            let totalFields = Object.keys(contractFields).length;
                            
                            // æ£€æŸ¥å¿…éœ€å­—æ®µ
                            const fieldChecks = {};
                            
                            // IDå­—æ®µæ£€æŸ¥
                            fieldChecks.service_id = provider.id ? 'âœ…' : 'âŒ ç¼ºå¤±';
                            if (provider.id) providerCompliance++;
                            
                            // æœåŠ¡åç§°æ£€æŸ¥
                            fieldChecks.service_name = provider.name ? 'âœ…' : 'âŒ ç¼ºå¤±';
                            if (provider.name) providerCompliance++;
                            
                            // æœåŠ¡ç±»å‹æ£€æŸ¥
                            const validTypes = contractFields.service_type.enum;
                            const hasValidType = validTypes.includes(type) || 
                                               (provider.type && validTypes.includes(provider.type));
                            fieldChecks.service_type = hasValidType ? 'âœ…' : `âŒ ç±»å‹"${type}"ä¸åœ¨å¥‘çº¦ä¸­`;
                            if (hasValidType) providerCompliance++;
                            
                            // æä¾›å•†æ£€æŸ¥
                            const validProviders = contractFields.provider.enum;
                            const hasValidProvider = validProviders.includes(type);
                            fieldChecks.provider = hasValidProvider ? 'âœ…' : `âš ï¸ æä¾›å•†"${type}"éœ€è¦éªŒè¯`;
                            if (hasValidProvider) providerCompliance++;
                            
                            // APIç«¯ç‚¹æ£€æŸ¥
                            fieldChecks.api_endpoint = provider.endpoint !== undefined ? 'âœ…' : 'âš ï¸ å¯é€‰å­—æ®µ';
                            providerCompliance++; // å¯é€‰å­—æ®µï¼Œç»™äºˆé€šè¿‡
                            
                            // é…ç½®å‚æ•°æ£€æŸ¥
                            const hasConfigParams = provider.models || provider.config_params;
                            fieldChecks.config_params = hasConfigParams ? 'âœ…' : 'âŒ ç¼ºå¤±';
                            if (hasConfigParams) providerCompliance++;
                            
                            // çŠ¶æ€æ£€æŸ¥
                            const validStatuses = contractFields.status.enum;
                            const providerStatus = provider.enabled ? 'active' : 'inactive';
                            const hasValidStatus = validStatuses.includes(providerStatus);
                            fieldChecks.status = hasValidStatus ? 'âœ…' : 'âŒ çŠ¶æ€ä¸åˆè§„';
                            if (hasValidStatus) providerCompliance++;
                            
                            // ä¼˜å…ˆçº§æ£€æŸ¥
                            fieldChecks.priority = provider.priority !== undefined ? 'âœ…' : 'âš ï¸ ä½¿ç”¨é»˜è®¤å€¼';
                            providerCompliance++; // æœ‰é»˜è®¤å€¼ï¼Œç»™äºˆé€šè¿‡
                            
                            // æˆæœ¬æ£€æŸ¥
                            fieldChecks.cost_per_token = provider.cost_per_token !== undefined ? 'âœ…' : 'âŒ ç¼ºå¤±';
                            if (provider.cost_per_token !== undefined) providerCompliance++;
                            
                            // åˆ›å»ºæ—¶é—´æ£€æŸ¥
                            fieldChecks.created_at = provider.createdAt ? 'âœ…' : 'âš ï¸ ç¼ºå¤±';
                            if (provider.createdAt) providerCompliance++;
                            
                            // æ›´æ–°æ—¶é—´æ£€æŸ¥
                            fieldChecks.updated_at = provider.updatedAt ? 'âœ…' : 'âš ï¸ å¯è‡ªåŠ¨ç”Ÿæˆ';
                            providerCompliance++; // å¯è‡ªåŠ¨ç”Ÿæˆï¼Œç»™äºˆé€šè¿‡
                            
                            const complianceRate = (providerCompliance / totalFields * 100).toFixed(1);
                            if (complianceRate >= 70) compliantProviders++;
                            
                            complianceResults[`${type}/${provider.id}`] = {
                                name: provider.name,
                                complianceRate,
                                fieldChecks
                            };
                        });
                    }
                });
                
                // ç”Ÿæˆç»“æœæŠ¥å‘Š
                const overallCompliance = totalProviders > 0 ? (compliantProviders / totalProviders * 100).toFixed(1) : 0;
                
                result += `ğŸ“Š æ€»ä½“åˆè§„æ€§: ${overallCompliance}% (${compliantProviders}/${totalProviders})\n\n`;
                
                result += `ğŸ“‹ å¥‘çº¦å­—æ®µéªŒè¯ç»“æœ:\n`;
                result += `â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n`;
                result += `â”‚ å­—æ®µå              â”‚ å¥‘çº¦è¦æ±‚                            â”‚\n`;
                result += `â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\n`;
                
                Object.entries(contractFields).forEach(([field, spec]) => {
                    const requirement = spec.enum ? 
                        `${spec.type} (${spec.enum.join('|')})` : 
                        spec.type;
                    result += `â”‚ ${field.padEnd(19)} â”‚ ${requirement.padEnd(35)} â”‚\n`;
                });
                result += `â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n\n`;
                
                // æ˜¾ç¤ºè¯¦ç»†çš„åˆè§„æ€§æ£€æŸ¥ç»“æœ
                result += `ğŸ” è¯¦ç»†åˆè§„æ€§æ£€æŸ¥:\n`;
                Object.entries(complianceResults).forEach(([providerKey, compliance]) => {
                    result += `\nğŸ“ ${compliance.name} (${providerKey}):\n`;
                    result += `   åˆè§„ç‡: ${compliance.complianceRate}%\n`;
                    Object.entries(compliance.fieldChecks).forEach(([field, status]) => {
                        result += `   ${field}: ${status}\n`;
                    });
                });
                
                const resultType = overallCompliance >= 80 ? 'success' : 
                                 overallCompliance >= 60 ? 'warning' : 'error';
                
                displayResult('database-contract-result', result, resultType);
                testResults.databaseContract = overallCompliance >= 70;

            } catch (error) {
                displayResult('database-contract-result', `âŒ æ•°æ®åº“å¥‘çº¦éªŒè¯å¤±è´¥: ${error.message}`, 'error');
                testResults.databaseContract = false;
            }
        };

        // Test 4a: æ·»åŠ æœåŠ¡å•†æŒ‰é’®æµ‹è¯•
        window.testAddProviderButton = async function() {
            if (!providerConfigModule) {
                displayResult('add-provider-result', 'âŒ è¯·å…ˆè¿è¡Œæ¨¡å—åŠ è½½æµ‹è¯•', 'error');
                return;
            }

            try {
                displayResult('add-provider-result', 'æ­£åœ¨æµ‹è¯•æ·»åŠ æœåŠ¡å•†åŠŸèƒ½...', 'info');
                
                let result = `ğŸ§ª æ·»åŠ æœåŠ¡å•†æŒ‰é’®åŠŸèƒ½æµ‹è¯•:\n\n`;
                
                // æµ‹è¯•showAddDialogæ–¹æ³•å­˜åœ¨æ€§
                const hasShowAddDialog = typeof providerConfigModule.showAddDialog === 'function';
                result += `âœ… showAddDialogæ–¹æ³•: ${hasShowAddDialog ? 'å­˜åœ¨' : 'âŒ ç¼ºå¤±'}\n`;
                
                // æµ‹è¯•saveProvideræ–¹æ³•å­˜åœ¨æ€§
                const hasSaveProvider = typeof providerConfigModule.saveProvider === 'function';
                result += `âœ… saveProvideræ–¹æ³•: ${hasSaveProvider ? 'å­˜åœ¨' : 'âŒ ç¼ºå¤±'}\n`;
                
                // æµ‹è¯•generateProviderOptionsæ–¹æ³•
                const hasGenerateOptions = typeof providerConfigModule.generateProviderOptions === 'function';
                result += `âœ… generateProviderOptionsæ–¹æ³•: ${hasGenerateOptions ? 'å­˜åœ¨' : 'âŒ ç¼ºå¤±'}\n`;
                
                // æµ‹è¯•onProviderTypeChangeæ–¹æ³•
                const hasTypeChange = typeof providerConfigModule.onProviderTypeChange === 'function';
                result += `âœ… onProviderTypeChangeæ–¹æ³•: ${hasTypeChange ? 'å­˜åœ¨' : 'âŒ ç¼ºå¤±'}\n`;
                
                // æµ‹è¯•æ”¯æŒçš„æœåŠ¡å•†ç±»å‹
                const supportedTypes = providerConfigModule.providerTypes || [];
                result += `ğŸ“‹ æ”¯æŒçš„æœåŠ¡å•†ç±»å‹: ${supportedTypes.length}ä¸ª\n`;
                result += `   ç±»å‹åˆ—è¡¨: ${supportedTypes.join(', ')}\n`;
                
                // éªŒè¯ç±»å‹åç§°æ˜ å°„
                const typeNameMappings = {};
                supportedTypes.forEach(type => {
                    typeNameMappings[type] = providerConfigModule.getProviderTypeName(type);
                });
                result += `\nğŸ·ï¸ ç±»å‹åç§°æ˜ å°„:\n`;
                Object.entries(typeNameMappings).forEach(([type, name]) => {
                    result += `   ${type} â†’ ${name}\n`;
                });
                
                // åŠŸèƒ½å®Œæ•´æ€§è¯„åˆ†
                const functionalityScore = [
                    hasShowAddDialog,
                    hasSaveProvider,
                    hasGenerateOptions,
                    hasTypeChange,
                    supportedTypes.length > 0
                ].filter(Boolean).length;
                
                const maxScore = 5;
                const completeness = (functionalityScore / maxScore * 100).toFixed(1);
                
                result += `\nğŸ“Š åŠŸèƒ½å®Œæ•´æ€§: ${completeness}% (${functionalityScore}/${maxScore})\n`;
                
                const resultType = completeness >= 80 ? 'success' : 
                                 completeness >= 60 ? 'warning' : 'error';
                
                displayResult('add-provider-result', result, resultType);
                testResults.addProvider = completeness >= 80;

            } catch (error) {
                displayResult('add-provider-result', `âŒ æ·»åŠ æœåŠ¡å•†æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                testResults.addProvider = false;
            }
        };

        // Test 4b: åŠ è½½æœåŠ¡å•†æµ‹è¯•
        window.testLoadProviders = async function() {
            if (!providerConfigModule) {
                displayResult('load-providers-result', 'âŒ è¯·å…ˆè¿è¡Œæ¨¡å—åŠ è½½æµ‹è¯•', 'error');
                return;
            }

            try {
                displayResult('load-providers-result', 'æ­£åœ¨æµ‹è¯•æœåŠ¡å•†åŠ è½½åŠŸèƒ½...', 'info');
                
                const startTime = Date.now();
                const loadResult = await providerConfigModule.loadProviders();
                const loadTime = Date.now() - startTime;
                
                let result = `ğŸ“‹ æœåŠ¡å•†åŠ è½½åŠŸèƒ½æµ‹è¯•:\n\n`;
                result += `â±ï¸ åŠ è½½æ—¶é—´: ${loadTime}ms\n`;
                result += `âœ… åŠ è½½çŠ¶æ€: ${loadResult.success ? 'æˆåŠŸ' : 'å¤±è´¥'}\n`;
                result += `ğŸ“Š æ•°æ®æº: ${loadResult.offline ? 'ç¦»çº¿ç¼“å­˜' : loadResult.fallback ? 'åå¤‡æ•°æ®' : 'åœ¨çº¿API'}\n`;
                
                if (loadResult.success && loadResult.providers) {
                    const providers = loadResult.providers;
                    const typeCount = Object.keys(providers).length;
                    let totalProviders = 0;
                    
                    result += `\nğŸ“ˆ åŠ è½½ç»“æœç»Ÿè®¡:\n`;
                    result += `   æœåŠ¡å•†ç±»å‹æ•°: ${typeCount}\n`;
                    
                    Object.entries(providers).forEach(([type, typeProviders]) => {
                        const count = Array.isArray(typeProviders) ? typeProviders.length : 0;
                        totalProviders += count;
                        result += `   ${type}: ${count}ä¸ªé…ç½®\n`;
                    });
                    
                    result += `   æ€»é…ç½®æ•°: ${totalProviders}\n`;
                    
                    // æµ‹è¯•æ¸²æŸ“åŠŸèƒ½
                    const hasRenderTable = typeof providerConfigModule.renderProviderTable === 'function';
                    const hasRenderRow = typeof providerConfigModule.renderProviderRow === 'function';
                    
                    result += `\nğŸ–¼ï¸ æ¸²æŸ“åŠŸèƒ½:\n`;
                    result += `   renderProviderTable: ${hasRenderTable ? 'âœ…' : 'âŒ'}\n`;
                    result += `   renderProviderRow: ${hasRenderRow ? 'âœ…' : 'âŒ'}\n`;
                    
                    if (hasRenderTable && totalProviders > 0) {
                        try {
                            const tableHTML = providerConfigModule.renderProviderTable();
                            const hasTable = tableHTML.includes('<table') && tableHTML.includes('</table>');
                            result += `   è¡¨æ ¼æ¸²æŸ“: ${hasTable ? 'âœ… æ­£å¸¸' : 'âŒ å¼‚å¸¸'}\n`;
                        } catch (renderError) {
                            result += `   è¡¨æ ¼æ¸²æŸ“: âŒ é”™è¯¯ - ${renderError.message}\n`;
                        }
                    }
                }
                
                const resultType = loadResult.success ? 'success' : 'warning';
                displayResult('load-providers-result', result, resultType);
                testResults.loadProviders = loadResult.success;

            } catch (error) {
                displayResult('load-providers-result', `âŒ åŠ è½½æœåŠ¡å•†æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                testResults.loadProviders = false;
            }
        };

        // Test 4c: ç¼–è¾‘æœåŠ¡å•†æµ‹è¯•
        window.testEditProviderButton = async function() {
            if (!providerConfigModule) {
                displayResult('edit-provider-result', 'âŒ è¯·å…ˆè¿è¡Œæ¨¡å—åŠ è½½æµ‹è¯•', 'error');
                return;
            }

            try {
                displayResult('edit-provider-result', 'æ­£åœ¨æµ‹è¯•ç¼–è¾‘æœåŠ¡å•†åŠŸèƒ½...', 'info');
                
                let result = `âœï¸ ç¼–è¾‘æœåŠ¡å•†åŠŸèƒ½æµ‹è¯•:\n\n`;
                
                // æµ‹è¯•ç¼–è¾‘ç›¸å…³æ–¹æ³•
                const hasEditProvider = typeof providerConfigModule.editProvider === 'function';
                const hasUpdateProvider = typeof providerConfigModule.updateProvider === 'function';
                const hasFindProviderById = typeof providerConfigModule.findProviderById === 'function';
                
                result += `ğŸ“‹ ç¼–è¾‘åŠŸèƒ½æ–¹æ³•æ£€æŸ¥:\n`;
                result += `   editProvider: ${hasEditProvider ? 'âœ…' : 'âŒ'}\n`;
                result += `   updateProvider: ${hasUpdateProvider ? 'âœ…' : 'âŒ'}\n`;
                result += `   findProviderById: ${hasFindProviderById ? 'âœ…' : 'âŒ'}\n`;
                
                // æµ‹è¯•æŸ¥æ‰¾åŠŸèƒ½
                const loadResult = await providerConfigModule.loadProviders();
                if (loadResult.success && loadResult.providers) {
                    result += `\nğŸ” æŸ¥æ‰¾åŠŸèƒ½æµ‹è¯•:\n`;
                    
                    let testProvider = null;
                    let testType = null;
                    
                    // æ‰¾åˆ°ç¬¬ä¸€ä¸ªå¯ç”¨çš„æœåŠ¡å•†è¿›è¡Œæµ‹è¯•
                    for (const [type, providers] of Object.entries(loadResult.providers)) {
                        if (Array.isArray(providers) && providers.length > 0) {
                            testProvider = providers[0];
                            testType = type;
                            break;
                        }
                    }
                    
                    if (testProvider && hasFindProviderById) {
                        const foundProvider = providerConfigModule.findProviderById(testType, testProvider.id);
                        result += `   æŸ¥æ‰¾æµ‹è¯•: ${foundProvider ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}\n`;
                        result += `   æµ‹è¯•å¯¹è±¡: ${testProvider.name} (${testType})\n`;
                    } else {
                        result += `   æŸ¥æ‰¾æµ‹è¯•: âš ï¸ æ— æµ‹è¯•æ•°æ®\n`;
                    }
                }
                
                // åŠŸèƒ½å®Œæ•´æ€§è¯„åˆ†
                const editFunctionality = [
                    hasEditProvider,
                    hasUpdateProvider,
                    hasFindProviderById
                ].filter(Boolean).length;
                
                const completeness = (editFunctionality / 3 * 100).toFixed(1);
                result += `\nğŸ“Š ç¼–è¾‘åŠŸèƒ½å®Œæ•´æ€§: ${completeness}%\n`;
                
                const resultType = completeness >= 80 ? 'success' : 
                                 completeness >= 60 ? 'warning' : 'error';
                
                displayResult('edit-provider-result', result, resultType);
                testResults.editProvider = completeness >= 80;

            } catch (error) {
                displayResult('edit-provider-result', `âŒ ç¼–è¾‘æœåŠ¡å•†æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                testResults.editProvider = false;
            }
        };

        // Test 4d: åˆ é™¤æœåŠ¡å•†æµ‹è¯•
        window.testDeleteProviderButton = async function() {
            if (!providerConfigModule) {
                displayResult('delete-provider-result', 'âŒ è¯·å…ˆè¿è¡Œæ¨¡å—åŠ è½½æµ‹è¯•', 'error');
                return;
            }

            try {
                displayResult('delete-provider-result', 'æ­£åœ¨æµ‹è¯•åˆ é™¤æœåŠ¡å•†åŠŸèƒ½...', 'info');
                
                let result = `ğŸ—‘ï¸ åˆ é™¤æœåŠ¡å•†åŠŸèƒ½æµ‹è¯•:\n\n`;
                
                // æµ‹è¯•åˆ é™¤æ–¹æ³•
                const hasDeleteProvider = typeof providerConfigModule.deleteProvider === 'function';
                result += `ğŸ“‹ åˆ é™¤åŠŸèƒ½æ–¹æ³•æ£€æŸ¥:\n`;
                result += `   deleteProvider: ${hasDeleteProvider ? 'âœ…' : 'âŒ'}\n`;
                
                // æµ‹è¯•åˆ·æ–°åŠŸèƒ½
                const hasRefreshProviders = typeof providerConfigModule.refreshProviders === 'function';
                result += `   refreshProviders: ${hasRefreshProviders ? 'âœ…' : 'âŒ'}\n`;
                
                // æµ‹è¯•localStorageæ¸…ç†èƒ½åŠ›ï¼ˆæ¨¡æ‹Ÿæµ‹è¯•ï¼‰
                try {
                    const testKey = 'admin_providers_test';
                    localStorage.setItem(testKey, JSON.stringify({ test: true }));
                    const canWrite = localStorage.getItem(testKey) !== null;
                    localStorage.removeItem(testKey);
                    result += `   localStorageæ“ä½œ: ${canWrite ? 'âœ…' : 'âŒ'}\n`;
                } catch (storageError) {
                    result += `   localStorageæ“ä½œ: âŒ é”™è¯¯\n`;
                }
                
                // å®‰å…¨æ€§æ£€æŸ¥
                result += `\nğŸ”’ å®‰å…¨æ€§æ£€æŸ¥:\n`;
                
                // æ£€æŸ¥æ˜¯å¦æœ‰ç¡®è®¤å¯¹è¯æ¡†æœºåˆ¶
                const deleteMethodSource = hasDeleteProvider ? 
                    providerConfigModule.deleteProvider.toString() : '';
                const hasConfirmDialog = deleteMethodSource.includes('confirm');
                result += `   åˆ é™¤ç¡®è®¤å¯¹è¯æ¡†: ${hasConfirmDialog ? 'âœ…' : 'âŒ ç¼ºå¤±'}\n`;
                
                // æ£€æŸ¥é”™è¯¯å¤„ç†
                const hasErrorHandling = deleteMethodSource.includes('try') && 
                                       deleteMethodSource.includes('catch');
                result += `   é”™è¯¯å¤„ç†æœºåˆ¶: ${hasErrorHandling ? 'âœ…' : 'âŒ ç¼ºå¤±'}\n`;
                
                // åŠŸèƒ½å®Œæ•´æ€§è¯„åˆ†
                const deleteFunctionality = [
                    hasDeleteProvider,
                    hasRefreshProviders,
                    hasConfirmDialog,
                    hasErrorHandling
                ].filter(Boolean).length;
                
                const completeness = (deleteFunctionality / 4 * 100).toFixed(1);
                result += `\nğŸ“Š åˆ é™¤åŠŸèƒ½å®Œæ•´æ€§: ${completeness}%\n`;
                
                const resultType = completeness >= 75 ? 'success' : 
                                 completeness >= 50 ? 'warning' : 'error';
                
                displayResult('delete-provider-result', result, resultType);
                testResults.deleteProvider = completeness >= 75;

            } catch (error) {
                displayResult('delete-provider-result', `âŒ åˆ é™¤æœåŠ¡å•†æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                testResults.deleteProvider = false;
            }
        };

        // Test 5a: å¯ç”¨/ç¦ç”¨æŒ‰é’®æµ‹è¯•
        window.testToggleProviderButton = async function() {
            if (!providerConfigModule) {
                displayResult('toggle-provider-result', 'âŒ è¯·å…ˆè¿è¡Œæ¨¡å—åŠ è½½æµ‹è¯•', 'error');
                return;
            }

            try {
                displayResult('toggle-provider-result', 'æ­£åœ¨æµ‹è¯•å¯ç”¨/ç¦ç”¨åŠŸèƒ½...', 'info');
                
                let result = `ğŸ”„ å¯ç”¨/ç¦ç”¨åŠŸèƒ½æµ‹è¯•:\n\n`;
                
                // æµ‹è¯•åˆ‡æ¢æ–¹æ³•
                const hasToggleProvider = typeof providerConfigModule.toggleProvider === 'function';
                result += `ğŸ“‹ åˆ‡æ¢åŠŸèƒ½æ–¹æ³•æ£€æŸ¥:\n`;
                result += `   toggleProvider: ${hasToggleProvider ? 'âœ…' : 'âŒ'}\n`;
                
                // æµ‹è¯•çŠ¶æ€ç®¡ç†
                const loadResult = await providerConfigModule.loadProviders();
                if (loadResult.success && loadResult.providers) {
                    let enabledCount = 0;
                    let disabledCount = 0;
                    let totalCount = 0;
                    
                    Object.values(loadResult.providers).forEach(providers => {
                        if (Array.isArray(providers)) {
                            providers.forEach(provider => {
                                totalCount++;
                                if (provider.enabled) {
                                    enabledCount++;
                                } else {
                                    disabledCount++;
                                }
                            });
                        }
                    });
                    
                    result += `\nğŸ“Š å½“å‰çŠ¶æ€ç»Ÿè®¡:\n`;
                    result += `   æ€»é…ç½®æ•°: ${totalCount}\n`;
                    result += `   å¯ç”¨é…ç½®: ${enabledCount}\n`;
                    result += `   ç¦ç”¨é…ç½®: ${disabledCount}\n`;
                    
                    // çŠ¶æ€å­—æ®µä¸€è‡´æ€§æ£€æŸ¥
                    const hasConsistentStatus = totalCount > 0;
                    result += `   çŠ¶æ€å­—æ®µä¸€è‡´æ€§: ${hasConsistentStatus ? 'âœ…' : 'âš ï¸ æ— æ•°æ®'}\n`;
                }
                
                // æ£€æŸ¥æ¸²æŸ“ä¸­çš„çŠ¶æ€æ˜¾ç¤º
                if (typeof providerConfigModule.renderProviderRow === 'function') {
                    const sampleProvider = {
                        id: 'test',
                        name: 'Test Provider',
                        type: 'openai',
                        enabled: true,
                        models: ['gpt-4'],
                        createdAt: new Date().toISOString()
                    };
                    
                    try {
                        const rowHTML = providerConfigModule.renderProviderRow(sampleProvider);
                        const hasStatusDisplay = rowHTML.includes('status-active') || 
                                               rowHTML.includes('status-inactive');
                        const hasToggleButton = rowHTML.includes('toggleProvider');
                        
                        result += `\nğŸ–¼ï¸ æ¸²æŸ“çŠ¶æ€æ£€æŸ¥:\n`;
                        result += `   çŠ¶æ€æ˜¾ç¤º: ${hasStatusDisplay ? 'âœ…' : 'âŒ'}\n`;
                        result += `   åˆ‡æ¢æŒ‰é’®: ${hasToggleButton ? 'âœ…' : 'âŒ'}\n`;
                    } catch (renderError) {
                        result += `\nğŸ–¼ï¸ æ¸²æŸ“çŠ¶æ€æ£€æŸ¥: âŒ æ¸²æŸ“é”™è¯¯\n`;
                    }
                }
                
                // åŠŸèƒ½å®Œæ•´æ€§è¯„åˆ†
                const toggleFunctionality = [
                    hasToggleProvider,
                    loadResult.success,
                ].filter(Boolean).length;
                
                const completeness = (toggleFunctionality / 2 * 100).toFixed(1);
                result += `\nğŸ“Š åˆ‡æ¢åŠŸèƒ½å®Œæ•´æ€§: ${completeness}%\n`;
                
                const resultType = completeness >= 80 ? 'success' : 
                                 completeness >= 60 ? 'warning' : 'error';
                
                displayResult('toggle-provider-result', result, resultType);
                testResults.toggleProvider = completeness >= 80;

            } catch (error) {
                displayResult('toggle-provider-result', `âŒ å¯ç”¨/ç¦ç”¨æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                testResults.toggleProvider = false;
            }
        };

        // Test 5b: è¿æ¥æµ‹è¯•æŒ‰é’®æµ‹è¯•
        window.testConnectionButton = async function() {
            if (!providerConfigModule) {
                displayResult('test-connection-result', 'âŒ è¯·å…ˆè¿è¡Œæ¨¡å—åŠ è½½æµ‹è¯•', 'error');
                return;
            }

            try {
                displayResult('test-connection-result', 'æ­£åœ¨æµ‹è¯•è¿æ¥æµ‹è¯•åŠŸèƒ½...', 'info');
                
                let result = `ğŸ§ª è¿æ¥æµ‹è¯•åŠŸèƒ½æµ‹è¯•:\n\n`;
                
                // æµ‹è¯•è¿æ¥æµ‹è¯•æ–¹æ³•
                const hasTestProvider = typeof providerConfigModule.testProvider === 'function';
                result += `ğŸ“‹ è¿æ¥æµ‹è¯•æ–¹æ³•æ£€æŸ¥:\n`;
                result += `   testProvider: ${hasTestProvider ? 'âœ…' : 'âŒ'}\n`;
                
                if (hasTestProvider) {
                    // æ£€æŸ¥æµ‹è¯•æ–¹æ³•çš„å®ç°
                    const testMethodSource = providerConfigModule.testProvider.toString();
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰APIè°ƒç”¨
                    const hasAPICall = testMethodSource.includes('api.testProvider') || 
                                     testMethodSource.includes('testProvider');
                    result += `   APIè°ƒç”¨å®ç°: ${hasAPICall ? 'âœ…' : 'âŒ'}\n`;
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰åå¤‡æµ‹è¯•æœºåˆ¶
                    const hasFallback = testMethodSource.includes('fallback') || 
                                      testMethodSource.includes('simulate');
                    result += `   åå¤‡æµ‹è¯•æœºåˆ¶: ${hasFallback ? 'âœ…' : 'âŒ'}\n`;
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰ç”¨æˆ·åé¦ˆ
                    const hasUserFeedback = testMethodSource.includes('showToast') || 
                                          testMethodSource.includes('Toast');
                    result += `   ç”¨æˆ·åé¦ˆæœºåˆ¶: ${hasUserFeedback ? 'âœ…' : 'âŒ'}\n`;
                    
                    // æ£€æŸ¥é”™è¯¯å¤„ç†
                    const hasErrorHandling = testMethodSource.includes('try') && 
                                           testMethodSource.includes('catch');
                    result += `   é”™è¯¯å¤„ç†: ${hasErrorHandling ? 'âœ…' : 'âŒ'}\n`;
                }
                
                // æ£€æŸ¥æ¸²æŸ“ä¸­çš„æµ‹è¯•æŒ‰é’®
                const loadResult = await providerConfigModule.loadProviders();
                if (loadResult.success && loadResult.providers) {
                    // æ‰¾ä¸€ä¸ªæµ‹è¯•å¯¹è±¡
                    let hasTestButton = false;
                    
                    for (const [type, providers] of Object.entries(loadResult.providers)) {
                        if (Array.isArray(providers) && providers.length > 0) {
                            try {
                                const rowHTML = providerConfigModule.renderProviderRow(providers[0]);
                                hasTestButton = rowHTML.includes('testProvider') && 
                                              rowHTML.includes('ğŸ§ª');
                                break;
                            } catch (e) {
                                // ç»§ç»­æµ‹è¯•ä¸‹ä¸€ä¸ª
                            }
                        }
                    }
                    
                    result += `\nğŸ–¼ï¸ UIæŒ‰é’®æ£€æŸ¥:\n`;
                    result += `   æµ‹è¯•æŒ‰é’®æ¸²æŸ“: ${hasTestButton ? 'âœ…' : 'âŒ'}\n`;
                }
                
                // åŠŸèƒ½å®Œæ•´æ€§è¯„åˆ†
                const testFunctionality = [
                    hasTestProvider,
                    testMethodSource && testMethodSource.includes('api'),
                    testMethodSource && testMethodSource.includes('catch'),
                ].filter(Boolean).length;
                
                const completeness = (testFunctionality / 3 * 100).toFixed(1);
                result += `\nğŸ“Š è¿æ¥æµ‹è¯•åŠŸèƒ½å®Œæ•´æ€§: ${completeness}%\n`;
                
                const resultType = completeness >= 70 ? 'success' : 
                                 completeness >= 50 ? 'warning' : 'error';
                
                displayResult('test-connection-result', result, resultType);
                testResults.testConnection = completeness >= 70;

            } catch (error) {
                displayResult('test-connection-result', `âŒ è¿æ¥æµ‹è¯•åŠŸèƒ½æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                testResults.testConnection = false;
            }
        };

        // Test 6: æ•°æ®éªŒè¯å’Œå®‰å…¨æµ‹è¯•
        window.testDataValidation = async function() {
            if (!providerConfigModule) {
                displayResult('data-validation-result', 'âŒ è¯·å…ˆè¿è¡Œæ¨¡å—åŠ è½½æµ‹è¯•', 'error');
                return;
            }

            try {
                displayResult('data-validation-result', 'æ­£åœ¨æµ‹è¯•æ•°æ®éªŒè¯å’Œå®‰å…¨æœºåˆ¶...', 'info');
                
                let result = `ğŸ”’ æ•°æ®éªŒè¯å’Œå®‰å…¨æµ‹è¯•:\n\n`;
                
                // æµ‹è¯•ä¿å­˜æ–¹æ³•çš„éªŒè¯æœºåˆ¶
                if (typeof providerConfigModule.saveProvider === 'function') {
                    const saveMethodSource = providerConfigModule.saveProvider.toString();
                    
                    result += `ğŸ“‹ ä¿å­˜æ•°æ®éªŒè¯æ£€æŸ¥:\n`;
                    
                    // å¿…å¡«å­—æ®µéªŒè¯
                    const hasRequiredValidation = saveMethodSource.includes('required') || 
                                                 saveMethodSource.includes('!type') || 
                                                 saveMethodSource.includes('!data.name');
                    result += `   å¿…å¡«å­—æ®µéªŒè¯: ${hasRequiredValidation ? 'âœ…' : 'âŒ'}\n`;
                    
                    // APIå¯†é’¥éªŒè¯
                    const hasApiKeyValidation = saveMethodSource.includes('apiKey') && 
                                               (saveMethodSource.includes('!data.apiKey') || 
                                                saveMethodSource.includes('apiKey.length'));
                    result += `   APIå¯†é’¥éªŒè¯: ${hasApiKeyValidation ? 'âœ…' : 'âŒ'}\n`;
                    
                    // æ¨¡å‹éªŒè¯
                    const hasModelValidation = saveMethodSource.includes('models') && 
                                              saveMethodSource.includes('length');
                    result += `   æ¨¡å‹é€‰æ‹©éªŒè¯: ${hasModelValidation ? 'âœ…' : 'âŒ'}\n`;
                    
                    // é”™è¯¯æ¶ˆæ¯æ˜¾ç¤º
                    const hasErrorMessages = saveMethodSource.includes('showToast') && 
                                           saveMethodSource.includes('error');
                    result += `   é”™è¯¯æ¶ˆæ¯æ˜¾ç¤º: ${hasErrorMessages ? 'âœ…' : 'âŒ'}\n`;
                }
                
                // æµ‹è¯•æ•°æ®æ¸…ç†å’Œè¿‡æ»¤
                result += `\nğŸ§¹ æ•°æ®æ¸…ç†æœºåˆ¶:\n`;
                
                // æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®è¿‡æ»¤
                const hasDataFiltering = providerConfigModule.providerTypes && 
                                        Array.isArray(providerConfigModule.providerTypes);
                result += `   æœåŠ¡å•†ç±»å‹è¿‡æ»¤: ${hasDataFiltering ? 'âœ…' : 'âŒ'}\n`;
                
                // æ£€æŸ¥APIå¯†é’¥æ©ç 
                if (typeof providerConfigModule.renderProviderRow === 'function') {
                    const testProvider = {
                        id: 1,
                        name: 'Test',
                        type: 'openai',
                        apiKey: 'sk-1234567890abcdef',
                        enabled: true,
                        models: ['gpt-4']
                    };
                    
                    try {
                        const rowHTML = providerConfigModule.renderProviderRow(testProvider);
                        const hasMaskedKey = rowHTML.includes('****') || 
                                           rowHTML.includes('masked') ||
                                           !rowHTML.includes('sk-1234567890abcdef');
                        result += `   APIå¯†é’¥æ©ç : ${hasMaskedKey ? 'âœ…' : 'âŒ å¯èƒ½æ³„éœ²'}\n`;
                    } catch (e) {
                        result += `   APIå¯†é’¥æ©ç : âŒ æ¸²æŸ“é”™è¯¯\n`;
                    }
                }
                
                // å®‰å…¨æ€§æ£€æŸ¥
                result += `\nğŸ›¡ï¸ å®‰å…¨æ€§æ£€æŸ¥:\n`;
                
                // æ£€æŸ¥localStorageä½¿ç”¨å®‰å…¨æ€§
                const moduleSource = providerConfigModule.constructor.toString() + 
                                   (providerConfigModule.saveProvider ? 
                                    providerConfigModule.saveProvider.toString() : '');
                
                const hasSecureStorage = moduleSource.includes('JSON.stringify') && 
                                       !moduleSource.includes('eval');
                result += `   å®‰å…¨å­˜å‚¨æœºåˆ¶: ${hasSecureStorage ? 'âœ…' : 'âš ï¸'}\n`;
                
                // æ£€æŸ¥XSSé˜²æŠ¤
                const hasXSSProtection = !moduleSource.includes('innerHTML =') || 
                                        moduleSource.includes('textContent');
                result += `   XSSé˜²æŠ¤: ${hasXSSProtection ? 'âœ…' : 'âš ï¸ éœ€è¦æ£€æŸ¥'}\n`;
                
                // åŠŸèƒ½å®Œæ•´æ€§è¯„åˆ†
                const validationFeatures = [
                    hasRequiredValidation,
                    hasApiKeyValidation,
                    hasModelValidation,
                    hasErrorMessages,
                    hasDataFiltering
                ].filter(Boolean).length;
                
                const completeness = (validationFeatures / 5 * 100).toFixed(1);
                result += `\nğŸ“Š æ•°æ®éªŒè¯å®Œæ•´æ€§: ${completeness}%\n`;
                
                const resultType = completeness >= 80 ? 'success' : 
                                 completeness >= 60 ? 'warning' : 'error';
                
                displayResult('data-validation-result', result, resultType);
                testResults.dataValidation = completeness >= 70;

            } catch (error) {
                displayResult('data-validation-result', `âŒ æ•°æ®éªŒè¯æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                testResults.dataValidation = false;
            }
        };

        // Test 7: é”™è¯¯å¤„ç†æµ‹è¯•
        window.testErrorHandling = async function() {
            if (!providerConfigModule) {
                displayResult('error-handling-result', 'âŒ è¯·å…ˆè¿è¡Œæ¨¡å—åŠ è½½æµ‹è¯•', 'error');
                return;
            }

            try {
                displayResult('error-handling-result', 'æ­£åœ¨æµ‹è¯•é”™è¯¯å¤„ç†æœºåˆ¶...', 'info');
                
                let result = `âš ï¸ é”™è¯¯å¤„ç†æœºåˆ¶æµ‹è¯•:\n\n`;
                
                // æµ‹è¯•æ¸²æŸ“é”™è¯¯çŠ¶æ€
                const hasRenderErrorState = typeof providerConfigModule.renderErrorState === 'function';
                result += `ğŸ“‹ é”™è¯¯çŠ¶æ€æ¸²æŸ“:\n`;
                result += `   renderErrorState: ${hasRenderErrorState ? 'âœ…' : 'âŒ'}\n`;
                
                if (hasRenderErrorState) {
                    try {
                        const errorHTML = providerConfigModule.renderErrorState('æµ‹è¯•é”™è¯¯ä¿¡æ¯');
                        const hasErrorIcon = errorHTML.includes('âš ï¸') || errorHTML.includes('error');
                        const hasReloadButton = errorHTML.includes('é‡æ–°åŠ è½½') || errorHTML.includes('reload');
                        
                        result += `   é”™è¯¯å›¾æ ‡æ˜¾ç¤º: ${hasErrorIcon ? 'âœ…' : 'âŒ'}\n`;
                        result += `   é‡æ–°åŠ è½½æŒ‰é’®: ${hasReloadButton ? 'âœ…' : 'âŒ'}\n`;
                    } catch (e) {
                        result += `   é”™è¯¯æ¸²æŸ“æµ‹è¯•: âŒ æ¸²æŸ“å¤±è´¥\n`;
                    }
                }
                
                // æµ‹è¯•ç©ºçŠ¶æ€æ¸²æŸ“
                const hasRenderEmptyState = typeof providerConfigModule.renderEmptyState === 'function';
                result += `\nğŸ“­ ç©ºçŠ¶æ€å¤„ç†:\n`;
                result += `   renderEmptyState: ${hasRenderEmptyState ? 'âœ…' : 'âŒ'}\n`;
                
                if (hasRenderEmptyState) {
                    try {
                        const emptyHTML = providerConfigModule.renderEmptyState();
                        const hasEmptyIcon = emptyHTML.includes('ğŸ“­') || emptyHTML.includes('empty');
                        const hasAddButton = emptyHTML.includes('æ·»åŠ ') || emptyHTML.includes('showAddDialog');
                        
                        result += `   ç©ºçŠ¶æ€å›¾æ ‡: ${hasEmptyIcon ? 'âœ…' : 'âŒ'}\n`;
                        result += `   æ·»åŠ å¼•å¯¼: ${hasAddButton ? 'âœ…' : 'âŒ'}\n`;
                    } catch (e) {
                        result += `   ç©ºçŠ¶æ€æ¸²æŸ“æµ‹è¯•: âŒ æ¸²æŸ“å¤±è´¥\n`;
                    }
                }
                
                // æµ‹è¯•æ–¹æ³•çš„é”™è¯¯å¤„ç†
                result += `\nğŸ› ï¸ æ–¹æ³•é”™è¯¯å¤„ç†æ£€æŸ¥:\n`;
                
                const methods = [
                    'loadProviders',
                    'saveProvider', 
                    'updateProvider',
                    'deleteProvider',
                    'testProvider'
                ];
                
                let methodsWithErrorHandling = 0;
                
                methods.forEach(methodName => {
                    if (typeof providerConfigModule[methodName] === 'function') {
                        const methodSource = providerConfigModule[methodName].toString();
                        const hasTryCatch = methodSource.includes('try') && methodSource.includes('catch');
                        const hasErrorLog = methodSource.includes('console.error') || 
                                          methodSource.includes('console.warn');
                        const hasUserFeedback = methodSource.includes('showToast');
                        
                        if (hasTryCatch || hasErrorLog) {
                            methodsWithErrorHandling++;
                        }
                        
                        result += `   ${methodName}: ${hasTryCatch ? 'âœ… try/catch' : 'âŒ'} `;
                        result += `${hasErrorLog ? 'âœ… æ—¥å¿—' : 'âŒ'} `;
                        result += `${hasUserFeedback ? 'âœ… åé¦ˆ' : 'âŒ'}\n`;
                    }
                });
                
                // æµ‹è¯•é™çº§æœºåˆ¶
                result += `\nğŸ”„ é™çº§æœºåˆ¶æ£€æŸ¥:\n`;
                
                const loadProviderSource = providerConfigModule.loadProviders ? 
                    providerConfigModule.loadProviders.toString() : '';
                
                const hasAPIFallback = loadProviderSource.includes('localStorage') && 
                                     loadProviderSource.includes('fallback');
                result += `   APIé™çº§åˆ°ç¼“å­˜: ${hasAPIFallback ? 'âœ…' : 'âŒ'}\n`;
                
                const hasOfflineMode = loadProviderSource.includes('offline') || 
                                     loadProviderSource.includes('cached');
                result += `   ç¦»çº¿æ¨¡å¼æ”¯æŒ: ${hasOfflineMode ? 'âœ…' : 'âŒ'}\n`;
                
                const hasStatusIndicator = providerConfigModule.render ? 
                    providerConfigModule.render.toString().includes('status-indicator') : false;
                result += `   çŠ¶æ€æŒ‡ç¤ºå™¨: ${hasStatusIndicator ? 'âœ…' : 'âŒ'}\n`;
                
                // åŠŸèƒ½å®Œæ•´æ€§è¯„åˆ†
                const errorHandlingFeatures = [
                    hasRenderErrorState,
                    hasRenderEmptyState,
                    methodsWithErrorHandling >= methods.length / 2,
                    hasAPIFallback,
                    hasOfflineMode,
                    hasStatusIndicator
                ].filter(Boolean).length;
                
                const completeness = (errorHandlingFeatures / 6 * 100).toFixed(1);
                result += `\nğŸ“Š é”™è¯¯å¤„ç†å®Œæ•´æ€§: ${completeness}%\n`;
                result += `é”™è¯¯å¤„ç†æ–¹æ³•è¦†ç›–ç‡: ${methodsWithErrorHandling}/${methods.length}\n`;
                
                const resultType = completeness >= 75 ? 'success' : 
                                 completeness >= 50 ? 'warning' : 'error';
                
                displayResult('error-handling-result', result, resultType);
                testResults.errorHandling = completeness >= 70;

            } catch (error) {
                displayResult('error-handling-result', `âŒ é”™è¯¯å¤„ç†æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                testResults.errorHandling = false;
            }
        };

        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        window.runAllTests = async function() {
            displayResult('final-result', 'ğŸ”„ æ­£åœ¨è¿è¡Œæ‰€æœ‰æµ‹è¯•...', 'info');
            
            // æŒ‰é¡ºåºè¿è¡Œæ‰€æœ‰æµ‹è¯•
            await testModuleLoading();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testAPIConnection();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testDatabaseContract();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testAddProviderButton();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testLoadProviders();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testEditProviderButton();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testDeleteProviderButton();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testToggleProviderButton();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testConnectionButton();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testDataValidation();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testErrorHandling();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // è®¡ç®—æœ€ç»ˆç»“æœ
            const totalTests = Object.keys(testResults).length;
            const passedTests = Object.values(testResults).filter(result => result === true).length;
            const successRate = totalTests > 0 ? ((passedTests / totalTests) * 100).toFixed(1) : 0;
            
            let finalResult = `ğŸ¯ æœåŠ¡å•†é…ç½®å…¨é¢æµ‹è¯•å®Œæˆ!\n\n`;
            finalResult += `ğŸ“Š æµ‹è¯•ç»“æœç»Ÿè®¡:\n`;
            finalResult += `  â€¢ æ€»æµ‹è¯•æ•°: ${totalTests}\n`;
            finalResult += `  â€¢ é€šè¿‡æµ‹è¯•: ${passedTests}\n`;
            finalResult += `  â€¢ å¤±è´¥æµ‹è¯•: ${totalTests - passedTests}\n`;
            finalResult += `  â€¢ æˆåŠŸç‡: ${successRate}%\n\n`;
            
            finalResult += `ğŸ“‹ è¯¦ç»†ç»“æœ:\n`;
            const testNames = {
                moduleLoading: 'æ¨¡å—åŠ è½½',
                apiConnection: 'APIè¿æ¥',
                databaseContract: 'æ•°æ®åº“å¥‘çº¦',
                addProvider: 'æ·»åŠ æœåŠ¡å•†',
                loadProviders: 'åŠ è½½æœåŠ¡å•†',
                editProvider: 'ç¼–è¾‘æœåŠ¡å•†',
                deleteProvider: 'åˆ é™¤æœåŠ¡å•†',
                toggleProvider: 'å¯ç”¨/ç¦ç”¨',
                testConnection: 'è¿æ¥æµ‹è¯•',
                dataValidation: 'æ•°æ®éªŒè¯',
                errorHandling: 'é”™è¯¯å¤„ç†'
            };
            
            Object.entries(testResults).forEach(([test, result]) => {
                const testName = testNames[test] || test;
                finalResult += `  â€¢ ${testName}: ${result ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}\n`;
            });
            
            // ç”Ÿæˆå»ºè®®
            finalResult += `\nğŸ’¡ æ”¹è¿›å»ºè®®:\n`;
            
            if (successRate >= 90) {
                finalResult += `ğŸ‰ æœåŠ¡å•†é…ç½®åŠŸèƒ½ä¼˜ç§€ï¼Œæ‰€æœ‰æŒ‰é’®åŠŸèƒ½å’Œæ•°æ®åº“å¥‘çº¦éƒ½ç¬¦åˆè¦æ±‚ï¼`;
            } else if (successRate >= 75) {
                finalResult += `âœ… æœåŠ¡å•†é…ç½®åŠŸèƒ½è‰¯å¥½ï¼Œå»ºè®®ä¿®å¤å¤±è´¥çš„æµ‹è¯•é¡¹ç›®ä»¥è¾¾åˆ°å®Œç¾çŠ¶æ€ã€‚`;
            } else if (successRate >= 60) {
                finalResult += `âš ï¸ æœåŠ¡å•†é…ç½®åŠŸèƒ½åŸºæœ¬å¯ç”¨ï¼Œä½†å­˜åœ¨ä¸€äº›é—®é¢˜éœ€è¦ä¿®å¤ï¼š\n`;
                Object.entries(testResults).forEach(([test, result]) => {
                    if (!result) {
                        const testName = testNames[test] || test;
                        finalResult += `  - ä¿®å¤${testName}åŠŸèƒ½\n`;
                    }
                });
            } else {
                finalResult += `âŒ æœåŠ¡å•†é…ç½®åŠŸèƒ½å­˜åœ¨ä¸¥é‡é—®é¢˜ï¼Œéœ€è¦ç«‹å³ä¿®å¤ï¼š\n`;
                Object.entries(testResults).forEach(([test, result]) => {
                    if (!result) {
                        const testName = testNames[test] || test;
                        finalResult += `  - ç´§æ€¥ä¿®å¤${testName}åŠŸèƒ½\n`;
                    }
                });
            }
            
            const resultType = successRate >= 80 ? 'success' : 
                             successRate >= 60 ? 'warning' : 'error';
            
            displayResult('final-result', `<div class="json-display">${finalResult}</div>`, resultType);
        };
    </script>
</body>
</html>