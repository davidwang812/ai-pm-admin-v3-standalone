<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœåŠ¡å•†é…ç½®å¥‘çº¦åˆè§„æ€§æµ‹è¯•</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            line-height: 1.6; 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #f5f5f5;
        }
        .test-container { 
            background: white; 
            border-radius: 8px; 
            padding: 20px; 
            margin-bottom: 20px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .test-header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; 
            padding: 20px; 
            border-radius: 8px 8px 0 0; 
            margin: -20px -20px 20px -20px;
        }
        .test-header h1 { margin: 0; font-size: 24px; }
        .test-header p { margin: 10px 0 0 0; opacity: 0.9; }
        .test-section { 
            margin: 20px 0; 
            padding: 15px; 
            border: 1px solid #e0e0e0; 
            border-radius: 6px;
        }
        .test-section h3 { 
            margin-top: 0; 
            color: #333; 
            border-bottom: 2px solid #667eea; 
            padding-bottom: 10px;
        }
        .test-item { 
            margin: 15px 0; 
            padding: 10px; 
            background: #f8f9fa; 
            border-radius: 4px;
            border-left: 4px solid #dee2e6;
        }
        .test-item.success { 
            border-left-color: #28a745; 
            background: #d4edda;
        }
        .test-item.warning { 
            border-left-color: #ffc107; 
            background: #fff3cd;
        }
        .test-item.error { 
            border-left-color: #dc3545; 
            background: #f8d7da;
        }
        .btn { 
            background: #667eea; 
            color: white; 
            border: none; 
            padding: 12px 20px; 
            border-radius: 6px; 
            cursor: pointer; 
            margin: 5px;
            font-size: 14px;
            transition: all 0.3s;
        }
        .btn:hover { 
            background: #5a67d8; 
            transform: translateY(-1px);
        }
        .btn.btn-success { background: #28a745; }
        .btn.btn-warning { background: #ffc107; color: #212529; }
        .btn.btn-danger { background: #dc3545; }
        .results { 
            margin-top: 20px; 
            font-family: 'Monaco', 'Menlo', monospace; 
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .contract-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .contract-table th, .contract-table td {
            border: 1px solid #dee2e6;
            padding: 8px 12px;
            text-align: left;
        }
        .contract-table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        .status-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        .status-compliant { background: #d4edda; color: #155724; }
        .status-partial { background: #fff3cd; color: #856404; }  
        .status-missing { background: #f8d7da; color: #721c24; }
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>ğŸ”§ æœåŠ¡å•†é…ç½®å¥‘çº¦åˆè§„æ€§æµ‹è¯•</h1>
            <p>éªŒè¯æœåŠ¡å•†é…ç½®æ¨¡å—ä¸AI_SERVICESæ•°æ®åº“å¥‘çº¦çš„ä¸€è‡´æ€§</p>
        </div>

        <div class="test-section">
            <h3>ğŸ“‹ æµ‹è¯•æ§åˆ¶é¢æ¿</h3>
            <button class="btn" onclick="runAllTests()">ğŸš€ è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
            <button class="btn btn-success" onclick="testContractMapping()">ğŸ—‚ï¸ æµ‹è¯•å¥‘çº¦æ˜ å°„</button>
            <button class="btn btn-warning" onclick="testDataMigration()">ğŸ”„ æµ‹è¯•æ•°æ®è¿ç§»</button>
            <button class="btn btn-danger" onclick="testProviderCRUD()">âš™ï¸ æµ‹è¯•CRUDæ“ä½œ</button>
            <button class="btn" onclick="clearResults()">ğŸ§¹ æ¸…ç©ºç»“æœ</button>
        </div>

        <div class="test-section">
            <h3>ğŸ¯ AI_SERVICESè¡¨å¥‘çº¦å®šä¹‰</h3>
            <div class="code-block">
AI_SERVICES {
    bigint service_id PK "æœåŠ¡ID"
    varchar service_name UK "æœåŠ¡åç§°"  
    varchar service_type "æœåŠ¡ç±»å‹: question/assist/draw/voice/video"
    varchar provider "æä¾›å•†: openai/anthropic/google"
    varchar api_endpoint "APIç«¯ç‚¹"
    json config_params "é…ç½®å‚æ•°"
    enum status "çŠ¶æ€: active/inactive/maintenance"
    int priority "ä¼˜å…ˆçº§"
    decimal cost_per_token "æ¯Tokenæˆæœ¬"
    timestamp created_at "åˆ›å»ºæ—¶é—´"
    timestamp updated_at "æ›´æ–°æ—¶é—´"
}
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š å¥‘çº¦å­—æ®µæ˜ å°„æ£€æŸ¥</h3>
            <table class="contract-table">
                <thead>
                    <tr>
                        <th>å¥‘çº¦å­—æ®µ</th>
                        <th>å®ç°å­—æ®µ</th>
                        <th>æ˜ å°„æ–¹å¼</th>
                        <th>çŠ¶æ€</th>
                    </tr>
                </thead>
                <tbody id="contract-mapping-table">
                    <tr><td colspan="4">ç‚¹å‡»"æµ‹è¯•å¥‘çº¦æ˜ å°„"æŸ¥çœ‹ç»“æœ</td></tr>
                </tbody>
            </table>
        </div>

        <div class="test-section">
            <h3>ğŸ§ª æµ‹è¯•ç»“æœ</h3>
            <div id="test-results" class="results">
                <p>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•...</p>
            </div>
        </div>
    </div>

    <script type="module">
        // å¯¼å…¥ProviderConfigæ¨¡å—è¿›è¡Œæµ‹è¯•
        import { ProviderConfig } from './_pages/ai-service/provider-config.js';

        // æ¨¡æ‹Ÿåº”ç”¨å¯¹è±¡
        const mockApp = {
            api: {
                getProviders: () => Promise.resolve({ success: false }),
                addProvider: () => Promise.resolve({ success: true }),
                updateProvider: () => Promise.resolve({ success: true }),
                deleteProvider: () => Promise.resolve({ success: true }),
                testProvider: () => Promise.resolve({ success: true })
            },
            showToast: (type, message) => {
                console.log(`Toast [${type}]: ${message}`);
                appendResult(`ğŸ“¢ Toast [${type}]: ${message}`);
            }
        };

        // åˆ›å»ºProviderConfigå®ä¾‹
        const providerConfig = new ProviderConfig(mockApp);
        
        // å…¨å±€æµ‹è¯•å‡½æ•°
        window.runAllTests = async function() {
            clearResults();
            appendResult('ğŸš€ å¼€å§‹è¿è¡Œæ‰€æœ‰æµ‹è¯•...\n');
            
            await testContractMapping();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testDataMigration();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testProviderCRUD();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            appendResult('\nâœ… æ‰€æœ‰æµ‹è¯•å®Œæˆï¼');
        };

        window.testContractMapping = function() {
            appendResult('ğŸ“‹ æµ‹è¯•å¥‘çº¦æ˜ å°„...\n');
            
            const contractFields = [
                'service_id', 'service_name', 'service_type', 'provider', 
                'api_endpoint', 'config_params', 'status', 'priority', 
                'cost_per_token', 'created_at', 'updated_at'
            ];

            const testProvider = {
                id: 1,
                name: 'Test Provider',
                apiKey: 'sk-test123',
                endpoint: 'https://api.test.com',
                models: ['test-model'],
                enabled: true,
                priority: 5
            };

            const contractProvider = providerConfig.buildContractCompliantProvider(testProvider, 'openai');
            
            let compliantCount = 0;
            const mappingResults = [];

            contractFields.forEach(field => {
                const hasField = contractProvider.hasOwnProperty(field);
                const status = hasField ? 'compliant' : 'missing';
                
                if (hasField) {
                    compliantCount++;
                    appendResult(`âœ… ${field}: ${JSON.stringify(contractProvider[field])}`);
                } else {
                    appendResult(`âŒ ${field}: ç¼ºå¤±å­—æ®µ`);
                }

                mappingResults.push({
                    contractField: field,
                    implementationField: hasField ? field : 'ç¼ºå¤±',
                    mappingType: hasField ? 'ç›´æ¥æ˜ å°„' : 'éœ€è¦æ·»åŠ ',
                    status: status
                });
            });

            // æ›´æ–°æ˜ å°„è¡¨
            updateContractMappingTable(mappingResults);

            const complianceScore = Math.round((compliantCount / contractFields.length) * 100);
            appendResult(`\nğŸ“Š å¥‘çº¦åˆè§„æ€§è¯„åˆ†: ${complianceScore}% (${compliantCount}/${contractFields.length})`);

            // æµ‹è¯•æœåŠ¡ç±»å‹æ˜ å°„
            appendResult('\nğŸ” æµ‹è¯•æœåŠ¡ç±»å‹æ˜ å°„:');
            Object.entries(providerConfig.serviceTypeMapping).forEach(([provider, serviceType]) => {
                appendResult(`  ${provider} â†’ ${serviceType}`);
            });

            // æµ‹è¯•çŠ¶æ€æ˜ å°„
            appendResult('\nğŸ” æµ‹è¯•çŠ¶æ€æ˜ å°„:');
            Object.entries(providerConfig.statusMapping).forEach(([enabled, status]) => {
                appendResult(`  enabled:${enabled} â†’ status:${status}`);
            });

            appendResult('\nâœ… å¥‘çº¦æ˜ å°„æµ‹è¯•å®Œæˆ\n');
        };

        window.testDataMigration = function() {
            appendResult('ğŸ”„ æµ‹è¯•æ•°æ®è¿ç§»...\n');

            // åˆ›å»ºæ—§æ ¼å¼çš„æµ‹è¯•æ•°æ®
            const oldFormatProvider = {
                id: 1,
                name: 'Legacy Provider',
                apiKey: 'sk-legacy123',
                endpoint: 'https://api.legacy.com',
                models: ['legacy-model'],
                enabled: true,
                priority: 3,
                createdAt: '2025-01-01T00:00:00Z'
            };

            // è®¾ç½®æµ‹è¯•æ•°æ®
            providerConfig.providers = {
                openai: [oldFormatProvider]
            };

            appendResult('ğŸ“¦ åŸå§‹æ•°æ®æ ¼å¼:');
            appendResult(JSON.stringify(oldFormatProvider, null, 2));

            // æ‰§è¡Œè¿ç§»
            const migrationCount = providerConfig.migrateProvidersToContractFormat();
            
            appendResult(`\nğŸ”„ è¿ç§»äº† ${migrationCount} ä¸ªæä¾›å•†`);

            // æ£€æŸ¥è¿ç§»åçš„æ•°æ®
            const migratedProvider = providerConfig.providers.openai[0];
            appendResult('\nğŸ“¦ è¿ç§»åæ•°æ®æ ¼å¼:');
            appendResult(JSON.stringify(migratedProvider, null, 2));

            // éªŒè¯å…³é”®å­—æ®µ
            const requiredContractFields = [
                'service_id', 'service_name', 'service_type', 'provider',
                'config_params', 'status', 'cost_per_token', 'created_at', 'updated_at'
            ];

            let validFields = 0;
            requiredContractFields.forEach(field => {
                if (migratedProvider.hasOwnProperty(field)) {
                    validFields++;
                    appendResult(`âœ… ${field}: å­˜åœ¨`);
                } else {
                    appendResult(`âŒ ${field}: ç¼ºå¤±`);
                }
            });

            const migrationScore = Math.round((validFields / requiredContractFields.length) * 100);
            appendResult(`\nğŸ“Š è¿ç§»æˆåŠŸç‡: ${migrationScore}% (${validFields}/${requiredContractFields.length})`);

            appendResult('\nâœ… æ•°æ®è¿ç§»æµ‹è¯•å®Œæˆ\n');
        };

        window.testProviderCRUD = async function() {
            appendResult('âš™ï¸ æµ‹è¯•CRUDæ“ä½œ...\n');

            try {
                // æµ‹è¯•æ·»åŠ æä¾›å•†
                appendResult('â• æµ‹è¯•æ·»åŠ æä¾›å•†:');
                const testData = {
                    name: 'Test CRUD Provider',
                    apiKey: 'sk-crud123',
                    endpoint: 'https://api.crud.com',
                    models: ['crud-model-1', 'crud-model-2'],
                    enabled: true,
                    priority: 10,
                    cost_per_token: 0.02
                };

                // æ¨¡æ‹Ÿè¡¨å•æ•°æ®
                const formData = new FormData();
                Object.entries(testData).forEach(([key, value]) => {
                    if (key === 'models') {
                        formData.append('selectedModels', value.join(','));
                    } else if (key === 'enabled') {
                        if (value) formData.append(key, 'on');
                    } else {
                        formData.append(key, value.toString());
                    }
                });

                // ç›´æ¥è°ƒç”¨ä¿å­˜é€»è¾‘ï¼ˆè·³è¿‡UIéƒ¨åˆ†ï¼‰
                appendResult('  è°ƒç”¨ä¿å­˜é€»è¾‘...');
                
                // æ„å»ºå¥‘çº¦å…¼å®¹çš„æä¾›å•†
                const contractProvider = providerConfig.buildContractCompliantProvider(testData, 'openai');
                appendResult('âœ… æˆåŠŸåˆ›å»ºå¥‘çº¦å…¼å®¹çš„æä¾›å•†æ•°æ®');

                // æµ‹è¯•æ›´æ–°æ“ä½œ
                appendResult('\nâœï¸ æµ‹è¯•æ›´æ–°æä¾›å•†:');
                const updateData = {
                    name: 'Updated CRUD Provider',
                    enabled: false,
                    priority: 15,
                    cost_per_token: 0.03,
                    service_type: 'assist',
                    status: 'inactive',
                    updated_at: new Date().toISOString()
                };

                const updatedProvider = { ...contractProvider, ...updateData };
                appendResult('âœ… æˆåŠŸæ›´æ–°æä¾›å•†æ•°æ®');

                // æµ‹è¯•çŠ¶æ€åˆ‡æ¢
                appendResult('\nğŸ”„ æµ‹è¯•çŠ¶æ€åˆ‡æ¢:');
                const toggledProvider = { ...updatedProvider };
                toggledProvider.status = toggledProvider.status === 'active' ? 'inactive' : 'active';
                toggledProvider.enabled = toggledProvider.status === 'active';
                appendResult(`âœ… çŠ¶æ€åˆ‡æ¢: ${updatedProvider.status} â†’ ${toggledProvider.status}`);

                // æµ‹è¯•æ•°æ®éªŒè¯
                appendResult('\nğŸ›¡ï¸ æµ‹è¯•æ•°æ®éªŒè¯:');
                const validationTests = [
                    { field: 'service_name', value: contractProvider.service_name, required: true },
                    { field: 'service_type', value: contractProvider.service_type, required: true },
                    { field: 'provider', value: contractProvider.provider, required: true },
                    { field: 'config_params', value: contractProvider.config_params, required: true },
                    { field: 'status', value: contractProvider.status, required: true },
                    { field: 'cost_per_token', value: contractProvider.cost_per_token, required: true }
                ];

                let validationPassed = 0;
                validationTests.forEach(test => {
                    const isValid = test.value !== undefined && test.value !== null && test.value !== '';
                    if (isValid) {
                        validationPassed++;
                        appendResult(`âœ… ${test.field}: éªŒè¯é€šè¿‡`);
                    } else {
                        appendResult(`âŒ ${test.field}: éªŒè¯å¤±è´¥`);
                    }
                });

                const validationScore = Math.round((validationPassed / validationTests.length) * 100);
                appendResult(`\nğŸ“Š æ•°æ®éªŒè¯é€šè¿‡ç‡: ${validationScore}% (${validationPassed}/${validationTests.length})`);

                appendResult('\nâœ… CRUDæ“ä½œæµ‹è¯•å®Œæˆ');

            } catch (error) {
                appendResult(`âŒ CRUDæµ‹è¯•å‡ºé”™: ${error.message}`);
            }

            appendResult('\n');
        };

        window.clearResults = function() {
            document.getElementById('test-results').innerHTML = '';
        };

        function appendResult(text) {
            const results = document.getElementById('test-results');
            results.innerHTML += text + '\n';
            results.scrollTop = results.scrollHeight;
        }

        function updateContractMappingTable(mappingResults) {
            const tbody = document.getElementById('contract-mapping-table');
            tbody.innerHTML = '';

            mappingResults.forEach(result => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${result.contractField}</td>
                    <td>${result.implementationField}</td>
                    <td>${result.mappingType}</td>
                    <td><span class="status-badge status-${result.status}">${result.status === 'compliant' ? 'âœ… å…¼å®¹' : 'âŒ ç¼ºå¤±'}</span></td>
                `;
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            appendResult('ğŸ¯ æœåŠ¡å•†é…ç½®å¥‘çº¦åˆè§„æ€§æµ‹è¯•ç³»ç»Ÿå·²å‡†å¤‡å°±ç»ª');
            appendResult('ğŸ“‹ ç‚¹å‡»"è¿è¡Œæ‰€æœ‰æµ‹è¯•"å¼€å§‹å®Œæ•´æµ‹è¯•ï¼Œæˆ–é€‰æ‹©å•é¡¹æµ‹è¯•');
            appendResult('ğŸ“„ æµ‹è¯•å°†éªŒè¯ä¸AI_SERVICESè¡¨å¥‘çº¦çš„ä¸€è‡´æ€§\n');
        });
    </script>
</body>
</html>