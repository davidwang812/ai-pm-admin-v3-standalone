<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§ª Contract Compliance Frontend Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .json-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            overflow-x: auto;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin: 2px;
        }
        .compliant {
            background: #28a745;
            color: white;
        }
        .non-compliant {
            background: #dc3545;
            color: white;
        }
        .deprecated {
            background: #ffc107;
            color: #212529;
        }
        .planned {
            background: #17a2b8;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§ª Contract Compliance Frontend Test</h1>
            <p>æµ‹è¯•å¥‘çº¦åˆè§„æ€§æ¨¡å—çš„å‰ç«¯åŠŸèƒ½å®ç°</p>
        </div>

        <div class="test-section">
            <h3>ğŸ“‹ Test 1: ContractCompliance Module Import</h3>
            <button onclick="testModuleImport()">æµ‹è¯•æ¨¡å—å¯¼å…¥</button>
            <div id="import-result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š Test 2: AI Service Contracts</h3>
            <button onclick="testServiceContracts()">æµ‹è¯•æœåŠ¡å¥‘çº¦å®šä¹‰</button>
            <div id="contracts-result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ”§ Test 3: Contract Compliant Configuration</h3>
            <button onclick="testContractCompliantConfig()">æµ‹è¯•åˆè§„é…ç½®æ„å»º</button>
            <div id="config-result"></div>
        </div>

        <div class="test-section">
            <h3>âœ… Test 4: Configuration Validation</h3>
            <button onclick="testConfigValidation()">æµ‹è¯•é…ç½®éªŒè¯</button>
            <div id="validation-result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ”„ Test 5: Old Config Migration</h3>
            <button onclick="testConfigMigration()">æµ‹è¯•é…ç½®è¿ç§»</button>
            <div id="migration-result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“ˆ Test 6: Compliance Score</h3>
            <button onclick="testComplianceScore()">æµ‹è¯•åˆè§„æ€§è¯„åˆ†</button>
            <div id="score-result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ¯ Final Test Result</h3>
            <button onclick="runAllTests()">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
            <div id="final-result"></div>
        </div>
    </div>

    <script type="module">
        // Import ContractCompliance from the deployed module
        let ContractCompliance;
        let contractManager;

        // Test results storage
        const testResults = {};

        // Utility functions
        function displayResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="test-result ${type}">${content}</div>`;
        }

        function formatJSON(obj) {
            return JSON.stringify(obj, null, 2);
        }

        // Test 1: Module Import
        window.testModuleImport = async function() {
            try {
                // Import the ContractCompliance module
                const module = await import('https://ai-pm-admin-v3-prod.vercel.app/_pages/ai-service/contract-compliance.js');
                ContractCompliance = module.ContractCompliance;
                contractManager = new ContractCompliance();
                
                const result = `
âœ… æ¨¡å—å¯¼å…¥æˆåŠŸ!
- ContractCompliance class: ${typeof ContractCompliance}
- Instance created: ${contractManager instanceof ContractCompliance}
- Contract version: ${contractManager.contractVersion}
- Last updated: ${contractManager.lastUpdated}
                `;
                
                displayResult('import-result', result, 'success');
                testResults.import = true;
            } catch (error) {
                displayResult('import-result', `âŒ æ¨¡å—å¯¼å…¥å¤±è´¥: ${error.message}`, 'error');
                testResults.import = false;
            }
        };

        // Test 2: Service Contracts
        window.testServiceContracts = function() {
            if (!contractManager) {
                displayResult('contracts-result', 'âŒ è¯·å…ˆè¿è¡Œæ¨¡å—å¯¼å…¥æµ‹è¯•', 'error');
                return;
            }

            try {
                const contracts = contractManager.getAIServiceContracts();
                const deprecated = contractManager.getDeprecatedServices();
                const providers = contractManager.getSupportedProviders();
                
                let result = `âœ… æœåŠ¡å¥‘çº¦æµ‹è¯•é€šè¿‡!\n\n`;
                
                // Active services
                result += `ğŸ“‹ æ´»è·ƒæœåŠ¡ (${Object.keys(contracts).length}):\n`;
                for (const [key, contract] of Object.entries(contracts)) {
                    const statusBadge = contract.status === 'active' ? 
                        `<span class="status-badge compliant">æ´»è·ƒ</span>` :
                        `<span class="status-badge planned">è®¡åˆ’ä¸­</span>`;
                    result += `  â€¢ ${contract.displayName} (${contract.contractType}) ${statusBadge}\n`;
                }
                
                // Deprecated services
                result += `\nâš ï¸  åºŸå¼ƒæœåŠ¡ (${Object.keys(deprecated).length}):\n`;
                for (const [key, service] of Object.entries(deprecated)) {
                    result += `  â€¢ ${service.displayName} - ${service.reason}\n`;
                }
                
                // Providers
                result += `\nğŸ”— æ”¯æŒçš„æä¾›å•† (${Object.keys(providers).length}):\n`;
                for (const [key, provider] of Object.entries(providers)) {
                    result += `  â€¢ ${provider.displayName} - æ”¯æŒæœåŠ¡: ${provider.supportedServices.join(', ')}\n`;
                }
                
                displayResult('contracts-result', `<div class="json-display">${result}</div>`, 'success');
                testResults.contracts = true;
            } catch (error) {
                displayResult('contracts-result', `âŒ æœåŠ¡å¥‘çº¦æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                testResults.contracts = false;
            }
        };

        // Test 3: Contract Compliant Configuration
        window.testContractCompliantConfig = function() {
            if (!contractManager) {
                displayResult('config-result', 'âŒ è¯·å…ˆè¿è¡Œæ¨¡å—å¯¼å…¥æµ‹è¯•', 'error');
                return;
            }

            try {
                // Test with a sample current config
                const currentConfig = {
                    globalParams: { temperature: 0.8, topP: 0.95, maxTokens: 1500 },
                    aiServices: {
                        questionAI: { enabled: true, provider: 'openai', prompt: 'Test prompt' },
                        translationAI: { enabled: true, provider: 'google', prompt: 'Translation prompt' }
                    }
                };
                
                const compliantConfig = contractManager.buildContractCompliantConfig(currentConfig);
                
                let result = `âœ… åˆè§„é…ç½®æ„å»ºæˆåŠŸ!\n\n`;
                result += `ğŸ“Š é…ç½®æ¦‚è§ˆ:\n`;
                result += `  â€¢ æ´»è·ƒæœåŠ¡: ${Object.keys(compliantConfig.aiServices).length}\n`;
                result += `  â€¢ è®¡åˆ’æœåŠ¡: ${Object.keys(compliantConfig.plannedServices).length}\n`;
                result += `  â€¢ åºŸå¼ƒæœåŠ¡: ${Object.keys(compliantConfig.deprecatedServices).length}\n`;
                result += `  â€¢ åˆè§„çŠ¶æ€: ${compliantConfig.contractInfo.complianceStatus}\n`;
                result += `  â€¢ å¥‘çº¦ç‰ˆæœ¬: ${compliantConfig.contractInfo.version}\n\n`;
                
                result += `ğŸ”§ ç¤ºä¾‹æœåŠ¡é…ç½®:\n`;
                const firstService = Object.values(compliantConfig.aiServices)[0];
                if (firstService) {
                    result += `${formatJSON(firstService)}`;
                }
                
                displayResult('config-result', `<div class="json-display">${result}</div>`, 'success');
                testResults.config = true;
            } catch (error) {
                displayResult('config-result', `âŒ åˆè§„é…ç½®æ„å»ºå¤±è´¥: ${error.message}`, 'error');
                testResults.config = false;
            }
        };

        // Test 4: Configuration Validation
        window.testConfigValidation = function() {
            if (!contractManager) {
                displayResult('validation-result', 'âŒ è¯·å…ˆè¿è¡Œæ¨¡å—å¯¼å…¥æµ‹è¯•', 'error');
                return;
            }

            try {
                // Test with compliant config
                const compliantConfig = {
                    aiServices: {
                        questionAI: { service_type: 'question', provider: 'openai' },
                        assistantAI: { service_type: 'assist', provider: 'moonshot' },
                        drawingAI: { service_type: 'draw', provider: 'google' }
                    }
                };
                
                // Test with non-compliant config
                const nonCompliantConfig = {
                    aiServices: {
                        invalidAI: { service_type: 'invalid', provider: 'unknown' },
                        translationAI: { service_type: 'translation', provider: 'google' }
                    }
                };
                
                const compliantValidation = contractManager.validateContractCompliance(compliantConfig);
                const nonCompliantValidation = contractManager.validateContractCompliance(nonCompliantConfig);
                
                let result = `âœ… é…ç½®éªŒè¯æµ‹è¯•å®Œæˆ!\n\n`;
                
                result += `ğŸ“‹ åˆè§„é…ç½®éªŒè¯:\n`;
                result += `  â€¢ åˆè§„çŠ¶æ€: ${compliantValidation.isCompliant ? 'âœ… åˆè§„' : 'âŒ ä¸åˆè§„'}\n`;
                result += `  â€¢ é”™è¯¯æ•°é‡: ${compliantValidation.errors.length}\n`;
                result += `  â€¢ è­¦å‘Šæ•°é‡: ${compliantValidation.warnings.length}\n`;
                result += `  â€¢ åˆè§„åˆ†æ•°: ${compliantValidation.complianceScore}/100\n\n`;
                
                result += `âš ï¸  éåˆè§„é…ç½®éªŒè¯:\n`;
                result += `  â€¢ åˆè§„çŠ¶æ€: ${nonCompliantValidation.isCompliant ? 'âœ… åˆè§„' : 'âŒ ä¸åˆè§„'}\n`;
                result += `  â€¢ é”™è¯¯æ•°é‡: ${nonCompliantValidation.errors.length}\n`;
                result += `  â€¢ è­¦å‘Šæ•°é‡: ${nonCompliantValidation.warnings.length}\n`;
                result += `  â€¢ åˆè§„åˆ†æ•°: ${nonCompliantValidation.complianceScore}/100\n`;
                
                if (nonCompliantValidation.errors.length > 0) {
                    result += `\nâŒ å‘ç°çš„é”™è¯¯:\n`;
                    nonCompliantValidation.errors.forEach(error => {
                        result += `  â€¢ ${error}\n`;
                    });
                }
                
                displayResult('validation-result', `<div class="json-display">${result}</div>`, 'info');
                testResults.validation = true;
            } catch (error) {
                displayResult('validation-result', `âŒ é…ç½®éªŒè¯å¤±è´¥: ${error.message}`, 'error');
                testResults.validation = false;
            }
        };

        // Test 5: Config Migration
        window.testConfigMigration = function() {
            if (!contractManager) {
                displayResult('migration-result', 'âŒ è¯·å…ˆè¿è¡Œæ¨¡å—å¯¼å…¥æµ‹è¯•', 'error');
                return;
            }

            try {
                const oldConfig = {
                    aiServices: {
                        translationAI: { enabled: true, provider: 'google', prompt: 'Translate this' },
                        ratingAI: { enabled: false, provider: 'openai', prompt: 'Rate this' },
                        questionAI: { enabled: true, provider: 'openai', prompt: 'Answer this' }
                    }
                };
                
                const migratedConfig = contractManager.migrateFromOldConfig(oldConfig);
                
                let result = `âœ… é…ç½®è¿ç§»æµ‹è¯•å®Œæˆ!\n\n`;
                
                result += `ğŸ“Š è¿ç§»ç»“æœæ¦‚è§ˆ:\n`;
                result += `  â€¢ è¿ç§»åæ´»è·ƒæœåŠ¡: ${Object.keys(migratedConfig.aiServices).length}\n`;
                result += `  â€¢ è¿ç§»ååºŸå¼ƒæœåŠ¡: ${Object.keys(migratedConfig.deprecatedServices).length}\n`;
                result += `  â€¢ è¿ç§»åè®¡åˆ’æœåŠ¡: ${Object.keys(migratedConfig.plannedServices).length}\n\n`;
                
                result += `ğŸ”„ åºŸå¼ƒæœåŠ¡å¤„ç†:\n`;
                for (const [key, service] of Object.entries(migratedConfig.deprecatedServices)) {
                    result += `  â€¢ ${key}: ${service.reason}\n`;
                    result += `    è¿ç§»åˆ°: ${service.autoMigrateTo}\n`;
                }
                
                displayResult('migration-result', `<div class="json-display">${result}</div>`, 'success');
                testResults.migration = true;
            } catch (error) {
                displayResult('migration-result', `âŒ é…ç½®è¿ç§»å¤±è´¥: ${error.message}`, 'error');
                testResults.migration = false;
            }
        };

        // Test 6: Compliance Score
        window.testComplianceScore = function() {
            if (!contractManager) {
                displayResult('score-result', 'âŒ è¯·å…ˆè¿è¡Œæ¨¡å—å¯¼å…¥æµ‹è¯•', 'error');
                return;
            }

            try {
                const configs = [
                    {
                        name: 'å®Œå…¨åˆè§„é…ç½®',
                        config: {
                            aiServices: {
                                questionAI: { service_id: 1, service_name: 'question_ai', service_type: 'question', provider: 'openai' },
                                assistantAI: { service_id: 2, service_name: 'assistant_ai', service_type: 'assist', provider: 'moonshot' },
                                drawingAI: { service_id: 3, service_name: 'drawing_ai', service_type: 'draw', provider: 'google' }
                            }
                        }
                    },
                    {
                        name: 'éƒ¨åˆ†åˆè§„é…ç½®',
                        config: {
                            aiServices: {
                                questionAI: { service_type: 'question', provider: 'openai' },
                                invalidAI: { service_type: 'invalid', provider: 'unknown' }
                            }
                        }
                    },
                    {
                        name: 'ä¸åˆè§„é…ç½®',
                        config: {
                            aiServices: {
                                randomAI: { service_type: 'random', provider: 'fake' }
                            }
                        }
                    }
                ];
                
                let result = `âœ… åˆè§„æ€§è¯„åˆ†æµ‹è¯•å®Œæˆ!\n\n`;
                
                configs.forEach(({ name, config }) => {
                    const score = contractManager.calculateComplianceScore(config);
                    const validation = contractManager.validateContractCompliance(config);
                    const recommendations = contractManager.getComplianceRecommendations(config);
                    
                    result += `ğŸ“Š ${name}:\n`;
                    result += `  â€¢ åˆè§„åˆ†æ•°: ${score}/100\n`;
                    result += `  â€¢ åˆè§„çŠ¶æ€: ${validation.isCompliant ? 'âœ… åˆè§„' : 'âŒ ä¸åˆè§„'}\n`;
                    result += `  â€¢ å»ºè®®æ•°é‡: ${recommendations.length}\n\n`;
                });
                
                displayResult('score-result', `<div class="json-display">${result}</div>`, 'info');
                testResults.score = true;
            } catch (error) {
                displayResult('score-result', `âŒ åˆè§„æ€§è¯„åˆ†å¤±è´¥: ${error.message}`, 'error');
                testResults.score = false;
            }
        };

        // Run All Tests
        window.runAllTests = async function() {
            displayResult('final-result', 'ğŸ”„ æ­£åœ¨è¿è¡Œæ‰€æœ‰æµ‹è¯•...', 'info');
            
            await testModuleImport();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            testServiceContracts();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            testContractCompliantConfig();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            testConfigValidation();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            testConfigMigration();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            testComplianceScore();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Calculate final results
            const totalTests = Object.keys(testResults).length;
            const passedTests = Object.values(testResults).filter(result => result === true).length;
            const successRate = ((passedTests / totalTests) * 100).toFixed(1);
            
            let finalResult = `ğŸ¯ æµ‹è¯•å®Œæˆ!\n\n`;
            finalResult += `ğŸ“Š æµ‹è¯•ç»“æœç»Ÿè®¡:\n`;
            finalResult += `  â€¢ æ€»æµ‹è¯•æ•°: ${totalTests}\n`;
            finalResult += `  â€¢ é€šè¿‡æµ‹è¯•: ${passedTests}\n`;
            finalResult += `  â€¢ å¤±è´¥æµ‹è¯•: ${totalTests - passedTests}\n`;
            finalResult += `  â€¢ æˆåŠŸç‡: ${successRate}%\n\n`;
            
            finalResult += `ğŸ“‹ è¯¦ç»†ç»“æœ:\n`;
            Object.entries(testResults).forEach(([test, result]) => {
                finalResult += `  â€¢ ${test}: ${result ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}\n`;
            });
            
            if (successRate >= 90) {
                finalResult += `\nğŸ‰ å¥‘çº¦åˆè§„æ€§å®ç°åŠŸèƒ½å®Œæ•´ï¼Œå¯ä»¥æŠ•å…¥ä½¿ç”¨!`;
                displayResult('final-result', `<div class="json-display">${finalResult}</div>`, 'success');
            } else if (successRate >= 70) {
                finalResult += `\nâš ï¸  å¤§éƒ¨åˆ†åŠŸèƒ½æ­£å¸¸ï¼Œå»ºè®®ä¿®å¤å¤±è´¥çš„æµ‹è¯•é¡¹ç›®ã€‚`;
                displayResult('final-result', `<div class="json-display">${finalResult}</div>`, 'info');
            } else {
                finalResult += `\nâŒ å­˜åœ¨é‡è¦é—®é¢˜ï¼Œéœ€è¦ç«‹å³ä¿®å¤ã€‚`;
                displayResult('final-result', `<div class="json-display">${finalResult}</div>`, 'error');
            }
        };
    </script>
</body>
</html>