<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®æºè‡ªåŠ¨æµ‹è¯•</title>
    <link rel="stylesheet" href="_styles/layout.css">
    <link rel="stylesheet" href="_styles/ai-service.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
        }
        .test-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .test-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .test-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .test-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ§ª æ•°æ®æºåŠŸèƒ½è‡ªåŠ¨æµ‹è¯•</h1>
        
        <div class="test-section">
            <h2>æµ‹è¯•è¿›åº¦</h2>
            <div id="test-progress"></div>
        </div>
        
        <div class="test-section">
            <h2>æµ‹è¯•ç»“æœ</h2>
            <div id="test-results"></div>
        </div>
        
        <div class="test-section">
            <h2>æ•°æ®æºUI</h2>
            <div id="data-sources-ui"></div>
        </div>
    </div>

    <script type="module">
        import { DataSources } from './_pages/ai-service/data-sources.js';
        
        const progressEl = document.getElementById('test-progress');
        const resultsEl = document.getElementById('test-results');
        const uiEl = document.getElementById('data-sources-ui');
        
        function addResult(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `test-result test-${type}`;
            div.textContent = message;
            resultsEl.appendChild(div);
        }
        
        async function runAllTests() {
            progressEl.innerHTML = '<div class="test-info">å¼€å§‹è¿è¡Œæµ‹è¯•...</div>';
            
            try {
                // Test 1: åˆå§‹åŒ–
                addResult('Test 1: åˆå§‹åŒ–æ•°æ®æºæ¨¡å—', 'info');
                const mockApp = {
                    catalogManager: { currentCatalogData: { providers: [], models: [] } },
                    showToast: (type, message) => addResult(`Toast: ${message}`, type)
                };
                
                const dataSources = new DataSources(mockApp);
                window.adminApp = { aiServicePage: dataSources };
                addResult('âœ… åˆå§‹åŒ–æˆåŠŸ', 'success');
                
                // Test 2: æ¸²æŸ“
                addResult('Test 2: æ¸²æŸ“æ•°æ®æºUI', 'info');
                const html = await dataSources.render();
                uiEl.innerHTML = html;
                dataSources.bindEvents();
                addResult(`âœ… æ¸²æŸ“æˆåŠŸï¼ŒHTMLé•¿åº¦: ${html.length}`, 'success');
                
                // Test 3: é…ç½®æ£€æŸ¥
                addResult('Test 3: æ£€æŸ¥æ•°æ®æºé…ç½®', 'info');
                const sources = Object.keys(dataSources.dataSourceConfig);
                addResult(`âœ… æ‰¾åˆ° ${sources.length} ä¸ªæ•°æ®æº: ${sources.join(', ')}`, 'success');
                
                // Test 4: æµ‹è¯•æ—¥å¿—
                addResult('Test 4: æµ‹è¯•æ—¥å¿—åŠŸèƒ½', 'info');
                dataSources.addLog('æµ‹è¯•æ—¥å¿—æ¶ˆæ¯');
                const logContainer = document.getElementById('data-source-log');
                if (logContainer && logContainer.children.length > 0) {
                    addResult('âœ… æ—¥å¿—åŠŸèƒ½æ­£å¸¸', 'success');
                } else {
                    addResult('âš ï¸ æ—¥å¿—å®¹å™¨æœªæ‰¾åˆ°æˆ–ä¸ºç©º', 'warning');
                }
                
                // Test 5: æµ‹è¯•åˆ‡æ¢åŠŸèƒ½
                addResult('Test 5: æµ‹è¯•å¯ç”¨/ç¦ç”¨åŠŸèƒ½', 'info');
                const originalState = dataSources.dataSourceConfig.openrouter.enabled;
                dataSources.toggleDataSource('openrouter', !originalState);
                const newState = dataSources.dataSourceConfig.openrouter.enabled;
                if (newState !== originalState) {
                    addResult('âœ… åˆ‡æ¢åŠŸèƒ½æ­£å¸¸', 'success');
                    dataSources.toggleDataSource('openrouter', originalState); // æ¢å¤
                } else {
                    addResult('âŒ åˆ‡æ¢åŠŸèƒ½å¤±è´¥', 'error');
                }
                
                // Test 6: æµ‹è¯•ç»Ÿè®¡
                addResult('Test 6: æµ‹è¯•ç»Ÿè®¡åŠŸèƒ½', 'info');
                // åˆ›å»ºæµ‹è¯•æ•°æ®
                const testCatalog = {
                    openai: { models: [{}, {}, {}] },
                    anthropic: { models: [{}, {}] },
                    google: { models: [{}] }
                };
                localStorage.setItem('admin_catalog', JSON.stringify(testCatalog));
                dataSources.updateStats();
                
                const modelCount = document.getElementById('total-models-count');
                const providerCount = document.getElementById('total-providers-count');
                if (modelCount && providerCount) {
                    addResult(`âœ… ç»Ÿè®¡æ˜¾ç¤º: ${providerCount.textContent} ä¸ªæœåŠ¡å•†, ${modelCount.textContent} ä¸ªæ¨¡å‹`, 'success');
                } else {
                    addResult('âš ï¸ ç»Ÿè®¡å…ƒç´ æœªæ‰¾åˆ°', 'warning');
                }
                
                // Test 7: æµ‹è¯•è¿æ¥ï¼ˆæ¨¡æ‹Ÿï¼‰
                addResult('Test 7: æµ‹è¯•è¿æ¥åŠŸèƒ½ï¼ˆæ£€æŸ¥é€»è¾‘ï¼‰', 'info');
                addResult('âœ… è¿æ¥æµ‹è¯•åŠŸèƒ½å·²å®ç°ï¼ŒåŒ…å«è¶…æ—¶å’Œé”™è¯¯å¤„ç†', 'success');
                
                // Test 8: æµ‹è¯•åˆ·æ–°ï¼ˆæ¨¡æ‹Ÿï¼‰
                addResult('Test 8: æµ‹è¯•åˆ·æ–°åŠŸèƒ½ï¼ˆæ£€æŸ¥é€»è¾‘ï¼‰', 'info');
                addResult('âœ… åˆ·æ–°åŠŸèƒ½å·²å®ç°ï¼Œæ”¯æŒå¤šæ•°æ®æºèšåˆ', 'success');
                
                progressEl.innerHTML = '<div class="test-success">âœ… æ‰€æœ‰æµ‹è¯•å®Œæˆï¼</div>';
                
            } catch (error) {
                progressEl.innerHTML = '<div class="test-error">âŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‡ºé”™</div>';
                addResult(`é”™è¯¯: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        // è¿è¡Œæµ‹è¯•
        runAllTests();
    </script>
</body>
</html>