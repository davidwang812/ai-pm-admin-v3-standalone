<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®æºå¯è§†åŒ–æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .test-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
        }
        .status.success {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .status.error {
            background: #ffebee;
            color: #c62828;
        }
        .status.pending {
            background: #fff3e0;
            color: #ef6c00;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #5a67d8;
        }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .iframe-container {
            width: 100%;
            height: 600px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>
<body>
    <div class="test-header">
        <h1>ğŸ§ª æ•°æ®æºé¡µé¢å¯è§†åŒ–æµ‹è¯•</h1>
        <p>æµ‹è¯•V3ç®¡ç†ç³»ç»Ÿçš„æ•°æ®æºåŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œ</p>
        <button onclick="runAllTests()">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
        <button onclick="window.open('https://ai-pm-admin-v3-prod.vercel.app', '_blank')">åœ¨æ–°çª—å£æ‰“å¼€</button>
    </div>

    <div class="test-grid">
        <div class="test-card">
            <h3>ğŸ“ æµ‹è¯•æ¸…å•</h3>
            <div id="test-checklist">
                <p>1. ç™»å½•åŠŸèƒ½ <span class="status pending" id="status-login">å¾…æµ‹è¯•</span></p>
                <p>2. é¡µé¢åŠ è½½ <span class="status pending" id="status-page">å¾…æµ‹è¯•</span></p>
                <p>3. AIæœåŠ¡å¯¼èˆª <span class="status pending" id="status-nav">å¾…æµ‹è¯•</span></p>
                <p>4. æ•°æ®æºæ ‡ç­¾ <span class="status pending" id="status-tab">å¾…æµ‹è¯•</span></p>
                <p>5. æŒ‰é’®åŠŸèƒ½ <span class="status pending" id="status-buttons">å¾…æµ‹è¯•</span></p>
                <p>6. æ¨¡å—åŠ è½½ <span class="status pending" id="status-modules">å¾…æµ‹è¯•</span></p>
            </div>
        </div>

        <div class="test-card">
            <h3>ğŸ“Š æµ‹è¯•ç»“æœ</h3>
            <div id="test-results">
                <pre>ç‚¹å‡»"è¿è¡Œæ‰€æœ‰æµ‹è¯•"å¼€å§‹...</pre>
            </div>
        </div>

        <div class="test-card">
            <h3>ğŸ” ä»£ç æ£€æŸ¥</h3>
            <div id="code-check">
                <pre>ç­‰å¾…æµ‹è¯•...</pre>
            </div>
        </div>

        <div class="test-card">
            <h3>âš¡ å¿«é€Ÿæ“ä½œ</h3>
            <button onclick="testLogin()">æµ‹è¯•ç™»å½•</button>
            <button onclick="checkDataSourceCode()">æ£€æŸ¥æ•°æ®æºä»£ç </button>
            <button onclick="checkAIServiceCode()">æ£€æŸ¥AIæœåŠ¡ä»£ç </button>
            <button onclick="openInFrame()">åœ¨iframeä¸­æ‰“å¼€</button>
        </div>
    </div>

    <div style="margin-top: 20px;">
        <div class="test-card">
            <h3>ğŸ–¼ï¸ é¡µé¢é¢„è§ˆ</h3>
            <div class="iframe-container">
                <iframe id="preview-frame" src="about:blank"></iframe>
            </div>
        </div>
    </div>

    <script>
        const BASE_URL = 'https://ai-pm-admin-v3-prod.vercel.app';
        let authToken = null;

        function updateStatus(id, status, text) {
            const elem = document.getElementById(`status-${id}`);
            elem.className = `status ${status}`;
            elem.textContent = text || status;
        }

        function log(message) {
            const results = document.getElementById('test-results');
            results.innerHTML = `<pre>${new Date().toLocaleTimeString()} - ${message}\n${results.querySelector('pre')?.textContent || ''}</pre>`;
        }

        async function testLogin() {
            updateStatus('login', 'pending', 'æµ‹è¯•ä¸­...');
            log('å¼€å§‹æµ‹è¯•ç™»å½•...');
            
            try {
                const response = await fetch(`${BASE_URL}/api/auth/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: 'davidwang812',
                        password: 'Admin@4444'
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    authToken = data.data.token;
                    updateStatus('login', 'success', 'æˆåŠŸ');
                    log(`âœ… ç™»å½•æˆåŠŸï¼ŒredirectUrl: ${data.data.redirectUrl}`);
                    return true;
                } else {
                    updateStatus('login', 'error', 'å¤±è´¥');
                    log(`âŒ ç™»å½•å¤±è´¥: ${data.message}`);
                    return false;
                }
            } catch (error) {
                updateStatus('login', 'error', 'é”™è¯¯');
                log(`âŒ ç™»å½•è¯·æ±‚å¤±è´¥: ${error.message}`);
                return false;
            }
        }

        async function checkDataSourceCode() {
            log('æ£€æŸ¥æ•°æ®æºä»£ç ...');
            
            try {
                const response = await fetch(`${BASE_URL}/_pages/ai-service/data-sources.js`);
                const code = await response.text();
                
                const checks = {
                    'DataSourcesç±»å®šä¹‰': /export class DataSources/,
                    'testDataSourcesæŒ‰é’®': /window\.adminV3App\.aiServicePage\.testDataSources/,
                    'refreshDataSourcesæŒ‰é’®': /window\.adminV3App\.aiServicePage\.refreshDataSources/,
                    'updateVercelUrlå‡½æ•°': /window\.adminV3App\.aiServicePage\.updateVercelUrl/,
                    'é”™è¯¯çš„adminAppå¼•ç”¨': /window\.adminApp\./
                };
                
                let results = [];
                for (const [name, pattern] of Object.entries(checks)) {
                    const found = pattern.test(code);
                    if (name.includes('é”™è¯¯')) {
                        results.push(`${found ? 'âŒ' : 'âœ…'} ${name}: ${found ? 'å‘ç°é”™è¯¯' : 'æœªå‘ç°ï¼ˆæ­£ç¡®ï¼‰'}`);
                    } else {
                        results.push(`${found ? 'âœ…' : 'âŒ'} ${name}: ${found ? 'æ‰¾åˆ°' : 'æœªæ‰¾åˆ°'}`);
                    }
                }
                
                document.getElementById('code-check').innerHTML = `<pre>${results.join('\n')}</pre>`;
                
                const hasErrors = results.some(r => r.startsWith('âŒ'));
                updateStatus('buttons', hasErrors ? 'error' : 'success', hasErrors ? 'æœ‰é—®é¢˜' : 'æ­£å¸¸');
                
                return !hasErrors;
            } catch (error) {
                log(`âŒ ä»£ç æ£€æŸ¥å¤±è´¥: ${error.message}`);
                return false;
            }
        }

        async function checkAIServiceCode() {
            log('æ£€æŸ¥AIæœåŠ¡ä¸»æ¨¡å—...');
            
            try {
                const response = await fetch(`${BASE_URL}/_pages/ai-service/index.js`);
                const code = await response.text();
                
                const checks = {
                    'AIServicePageç±»': /export class AIServicePage/,
                    'å…¨å±€ç»‘å®š': /window\.adminV3App\.aiServicePage = this/,
                    'testDataSourcesæ–¹æ³•': /async testDataSources\(\)/,
                    'refreshDataSourcesæ–¹æ³•': /async refreshDataSources\(\)/
                };
                
                let allGood = true;
                for (const [name, pattern] of Object.entries(checks)) {
                    const found = pattern.test(code);
                    log(`${found ? 'âœ…' : 'âŒ'} ${name}: ${found ? 'æ‰¾åˆ°' : 'æœªæ‰¾åˆ°'}`);
                    if (!found) allGood = false;
                }
                
                updateStatus('modules', allGood ? 'success' : 'error', allGood ? 'æ­£å¸¸' : 'æœ‰é—®é¢˜');
                return allGood;
            } catch (error) {
                log(`âŒ æ¨¡å—æ£€æŸ¥å¤±è´¥: ${error.message}`);
                return false;
            }
        }

        function openInFrame() {
            const iframe = document.getElementById('preview-frame');
            iframe.src = BASE_URL;
            log('å·²åœ¨iframeä¸­æ‰“å¼€ç®¡ç†é¡µé¢');
        }

        async function runAllTests() {
            log('ğŸš€ å¼€å§‹è¿è¡Œæ‰€æœ‰æµ‹è¯•...');
            
            // 1. ç™»å½•æµ‹è¯•
            const loginSuccess = await testLogin();
            if (!loginSuccess) {
                log('âŒ ç™»å½•å¤±è´¥ï¼Œåœæ­¢æµ‹è¯•');
                return;
            }
            
            // 2. é¡µé¢åŠ è½½æµ‹è¯•
            updateStatus('page', 'pending', 'æµ‹è¯•ä¸­...');
            openInFrame();
            setTimeout(() => {
                updateStatus('page', 'success', 'å·²åŠ è½½');
                log('âœ… é¡µé¢åŠ è½½æˆåŠŸ');
            }, 2000);
            
            // 3. ä»£ç æ£€æŸ¥
            await checkDataSourceCode();
            await checkAIServiceCode();
            
            // 4. å¯¼èˆªå’Œæ ‡ç­¾æµ‹è¯•éœ€è¦æ‰‹åŠ¨éªŒè¯
            updateStatus('nav', 'pending', 'éœ€æ‰‹åŠ¨éªŒè¯');
            updateStatus('tab', 'pending', 'éœ€æ‰‹åŠ¨éªŒè¯');
            
            log('âœ… è‡ªåŠ¨æµ‹è¯•å®Œæˆï¼Œè¯·æ‰‹åŠ¨éªŒè¯å¯¼èˆªåŠŸèƒ½');
        }
    </script>
</body>
</html>